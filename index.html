
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>NEW CROWN Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Ê¥óÁ∑¥„Åï„Çå„Åü„Éì„Ç∏„Éç„ÇπÂêë„Åë„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
            --primary-coral: #f59e0b;        /* ‰∏äÂìÅ„Å™„Ç¢„É≥„Éê„Éº„Ç¥„Éº„É´„Éâ - Ê∏©„Åã„Åø„Å®Ê¥ªÂäõ */
            --primary-sage: #059669;         /* Ê∑±„ÅÑ„Ç®„É°„É©„É´„Éâ„Ç∞„É™„Éº„É≥ - ÊàêÈï∑„Å®ÂÆâÂÆö */
            --primary-sky: #0ea5e9;          /* Ê¥ª„ÅçÊ¥ª„Åç„Å®„Åó„Åü„Çπ„Ç´„Ç§„Éñ„É´„Éº - Ê∏ÖÊ∂ºÊÑü„Å®‰ø°È†º */
            --primary-lavender: #7c3aed;     /* „É™„ÉÉ„ÉÅ„Å™„Éë„Éº„Éó„É´ - ÂâµÈÄ†ÊÄß„Å®ÂìÅÊ†º */
            --accent-peach: #fbbf24;         /* „ÇΩ„Éï„Éà„Ç¥„Éº„É´„Éâ - ÂÑ™ÈõÖ„Å™„Ç¢„ÇØ„Çª„É≥„Éà */
            --accent-mint: #10b981;          /* „Éï„É¨„ÉÉ„Ç∑„É•„Éü„É≥„Éà - Ê¥ªÂäõ„Å®Êñ∞ÈÆÆ„Åï */
            --bg-cream: #ffffff;             /* „Éî„É•„Ç¢„Éõ„ÉØ„Ç§„Éà - Ê∏ÖÊΩîÊÑü */
            --bg-white: #ffffff;             /* „Éî„É•„Ç¢„Éõ„ÉØ„Ç§„Éà - ÊúÄÈ´ò„ÅÆË¶ñË™çÊÄß */
            --text-dark: #1f2937;            /* Ê∑±„ÅÑ„ÉÅ„É£„Ç≥„Éº„É´ - Ë™≠„Åø„ÇÑ„Åô„ÅïÈáçË¶ñ */
            --text-warm: #374151;            /* Ê∏©„Åã„ÅÑ„Ç∞„É¨„Éº - ÁõÆ„Å´ÂÑ™„Åó„ÅÑ */
            --border-soft: #f3f4f6;          /* „ÇΩ„Éï„Éà„Ç∞„É¨„Éº - ‰∏äÂìÅ„Å™Â¢ÉÁïåÁ∑ö */
            --shadow-gentle: rgba(59, 130, 246, 0.08);  /* „Éñ„É´„ÉºÁ≥ª„Ç∑„É£„Éâ„Ç¶ - Áü•ÁöÑ„Å™Âç∞Ë±° */
        }
        
        body {
            font-family: "Noto Sans JP", "Inter", sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: var(--text-dark);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            padding-top: 5rem;
            padding-bottom: 2rem;
        }
        
        /* Âü∫Êú¨„É¨„Ç§„Ç¢„Ç¶„Éà */
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }
        @media (min-width: 640px) {
            .container-spacing { max-width: 500px; }
        }
        @media (min-width: 768px) {
            .container-spacing { max-width: 600px; }
        }
        @media (min-width: 1024px) {
            .container-spacing { max-width: 700px; }
        }
        
        /* „Çø„Ç§„Éà„É´ */
        .game-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-coral);
            text-align: center;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }
        
        /* „Ç´„Éº„Éâ */
        .warm-card {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow-gentle);
            position: relative;
            overflow: hidden;
        }
        
        /* „É°„Ç§„É≥„Éú„Çø„É≥ */
        .warm-button {
            background: var(--primary-coral);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        .warm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.35);
            background: #d97706;
        }
        .warm-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
        }
        .warm-button:disabled {
            background: #d1d5db;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* Â≠¶Âπ¥ÈÅ∏Êäû„Éú„Çø„É≥ */
        .grade-btn {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            color: var(--text-warm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow-gentle);
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        .grade-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
            background: #fefefe;
        }
        .grade-btn.active {
            background: #fefefe;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.25);
        }
        .grade-btn.disabled {
            background: #f8fafc;
            color: #cbd5e1;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }
        .grade-btn.disabled:hover {
            transform: none;
            box-shadow: 0 4px 16px var(--shadow-gentle);
        }
        
        /* Ê∫ñÂÇô‰∏≠„É©„Éô„É´ */
        .coming-soon {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 3;
            box-shadow: 0 2px 6px rgba(251, 191, 36, 0.3);
        }
        
        /* „É¨„ÉÉ„Çπ„É≥„Éú„Çø„É≥ */
        .lesson-btn {
            background: #ffffff;
            border: 2px solid var(--border-soft);
            border-radius: 16px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.08);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        .lesson-btn:hover {
            border-color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(14, 165, 233, 0.15);
            background: #fefefe;
        }
        .lesson-btn.selected {
            background: #fefefe;
            border-color: var(--primary-sky);
            color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(14, 165, 233, 0.25);
        }
        .lesson-btn.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-sky);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* ÊñáÊ≥ï„Éú„Çø„É≥ */
        .grammar-btn {
            background: #ffffff;
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.6rem 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 50px;
            box-shadow: 0 3px 10px rgba(124, 58, 237, 0.06);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        .grammar-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.12);
            background: #fefefe;
        }
        .grammar-btn.selected {
            background: #fefefe;
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.25);
        }
        .grammar-btn.selected::after {
            content: '‚úì';
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--primary-lavender);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* ÂÖ®ÈÅ∏Êäû„Éú„Çø„É≥ */
        .select-all-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #fefefe);
            border-radius: 12px;
            border: 1px solid var(--border-soft);
        }
        
        .select-all-btn {
            background: transparent;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        
        .select-all-btn:hover {
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            background: rgba(124, 58, 237, 0.03);
        }
        
        .select-all-btn.active {
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            background: rgba(124, 58, 237, 0.08);
        }
        
        .select-all-icon {
            font-size: 0.7rem;
        }
        
        /* ÈÅ∏Êäû„Åó„ÅüÊñáÊ≥ïÈ†ÖÁõÆË°®Á§∫Ôºà„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Á∏ÆÂ∞èÔºâ */
        #currentCategory {
            font-size: 0.8rem !important;
            line-height: 1.3 !important;
            color: #6b7280 !important;
            overflow: visible !important;
            word-wrap: break-word !important;
        }
        
        /* „É¢„Éº„ÉÄ„É´Âü∫Êú¨Ë®≠ÂÆö - PCÁîªÈù¢„Åß„ÅÆ‰∏≠Â§ÆÈÖçÁΩÆ„ÇíÂº∑Âåñ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(8px);
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.show {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 8rem 1rem 6rem 1rem !important;
            animation: modalFadeIn 0.4s ease-out;
            box-sizing: border-box !important;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* PCÁîªÈù¢„Åß„ÅÆÁ¢∫ÂÆü„Å™‰∏≠Â§ÆÈÖçÁΩÆ */
        .modal-content {
            width: 100% !important;
            max-width: 600px !important;
            margin: 0 auto !important;
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* PCÁîªÈù¢Ôºà768px‰ª•‰∏äÔºâ„Åß„ÅÆ„Çà„ÇäÁ¢∫ÂÆü„Å™‰∏≠Â§ÆÈÖçÁΩÆ */
        @media (min-width: 768px) {
            .modal.show {
                align-items: center !important;
                justify-content: center !important;
                padding: 2rem !important;
            }
            
            .modal-content {
                position: static !important;
                left: auto !important;
                transform: none !important;
                width: 100% !important;
                max-width: 600px !important;
                margin: 0 auto !important;
            }
        }
        
        /* „ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´Â∞ÇÁî®Ë®≠ÂÆö */
        #quizModal {
            justify-content: flex-start !important;
            align-items: center !important;
            padding: 6rem 0 6rem 0 !important;
        }
        
        #quizModal .modal-content {
            width: 95% !important;
            max-width: 550px !important;
            min-width: 300px !important;
            margin: 0 auto !important;
            position: relative !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            padding: 0 !important;
        }
        
        /* PCÁîªÈù¢„Åß„ÅÆ„ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´‰∏≠Â§ÆÈÖçÁΩÆ */
        @media (min-width: 768px) {
            #quizModal {
                align-items: center !important;
                justify-content: center !important;
                padding: 2rem !important;
            }
            
            #quizModal .modal-content {
                position: static !important;
                left: auto !important;
                transform: none !important;
                width: 100% !important;
                max-width: 550px !important;
                margin: 0 auto !important;
            }
        }
        
        /* „ÇØ„Ç§„Ç∫„Ç´„Éº„Éâ */
        .quiz-card {
            background: #ffffff !important;
            border: 3px solid var(--border-soft) !important;
            border-radius: 24px !important;
            box-shadow: 0 8px 32px var(--shadow-gentle) !important;
            position: relative !important;
            overflow: hidden !important;
            padding: 1rem !important;
            width: 100% !important;
            margin: 0 !important;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº */
        .fixed-header {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1001;
            animation: floatingHeader 3s ease-in-out infinite;
            max-width: 90vw;
            overflow: hidden;
            background: transparent;
        }
        
        @keyframes floatingHeader {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-3px); }
        }
        
        .header-stat-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
            border: 1.5px solid rgba(124, 58, 237, 0.12);
            border-radius: 18px;
            padding: 0.4rem 0.7rem;
            min-width: 60px;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.08);
        }
        
        .header-stat-item:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.18);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.98));
            border-color: rgba(124, 58, 237, 0.25);
        }
        
        .header-nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .header-nav-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .header-nav-item:hover::before {
            opacity: 1;
        }
        
        .header-nav-item:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .header-nav-item.home {
            background: linear-gradient(135deg, var(--primary-coral), #d97706);
        }
        
        .header-nav-item.back {
            background: linear-gradient(135deg, var(--primary-sage), #047857);
        }
        
        .header-nav-item.voice {
            background: linear-gradient(135deg, var(--primary-lavender), #6d28d9);
        }
        
        .header-stat-number {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary-lavender);
        }
        
        .header-stat-emoji {
            font-size: 1.1rem;
        }
        
        /* Èü≥Â£∞Ë®≠ÂÆö */
        .voice-gender-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 120px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(124, 58, 237, 0.08);
            margin-bottom: 1rem;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        .voice-gender-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.15);
            background: #fefefe;
        }

        .voice-gender-btn.selected {
            border-color: var(--primary-lavender);
            background: linear-gradient(135deg, #fefefe, #ffffff);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.25);
        }

        .voice-gender-btn.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-lavender);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .voice-gender-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .voice-gender-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .voice-gender-description {
            font-size: 0.85rem;
            color: var(--text-warm);
            line-height: 1.4;
        }

        .simple-voice-container {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #ffffff, #fefefe);
            border-radius: 16px;
            border: 2px solid var(--border-soft);
        }

        .voice-selection-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .voice-toggle {
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 0.75rem;
            background: #ffffff;
            border-radius: 12px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ddd;
            transition: .4s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-sage);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* „Éú„Çø„É≥„Ç≥„É≥„ÉÜ„Éä */
        .action-button-container {
            position: sticky;
            bottom: 0;
            background: linear-gradient(to top, #ffffff, rgba(255, 255, 255, 0.98));
            padding: 1.5rem 1rem;
            margin: -1rem;
            margin-top: 2rem;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            backdrop-filter: blur(8px);
        }
        
        /* Èü≥Â£∞„Éú„Çø„É≥ - ÂÆåÂÖ®‰øÆÊ≠£Áâà */
        .speak-btn {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 40px !important;
            height: 40px !important;
            background: #059669 !important;
            border: none !important;
            border-radius: 50% !important;
            color: white !important;
            font-size: 18px !important;
            margin-left: 12px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            vertical-align: middle !important;
            flex-shrink: 0 !important;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3) !important;
            z-index: 10 !important;
            position: relative !important;
        }
        
        .speak-btn:hover {
            background: #047857 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4) !important;
        }
        
        .speak-btn:active {
            transform: scale(0.95) !important;
        }
        
        .speak-btn.speaking {
            background: #f59e0b !important;
            animation: speakPulse 1s infinite !important;
        }
        
        @keyframes speakPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        /* Èü≥Â£∞„Éú„Çø„É≥‰ªò„Åç„ÉÜ„Ç≠„Çπ„Éà„É©„ÉÉ„Éë„Éº - ÂÆåÂÖ®‰øÆÊ≠£Áâà */
        .text-with-speaker {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 15px !important;
            flex-wrap: wrap !important;
            line-height: 1.6 !important;
            width: 100% !important;
            min-height: 60px !important;
            padding: 10px !important;
            background: rgba(255, 255, 255, 0.05) !important;
            border-radius: 12px !important;
        }
        
        .text-with-speaker .text-content {
            flex: 1 !important;
            min-width: 200px !important;
            text-align: center !important;
            font-size: inherit !important;
            line-height: inherit !important;
        }
        
        /* „Çø„Ç§„Éû„Éº */
        .timer-display {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            transition: all 0.3s ease;
            border: 4px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .timer-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.3) 50%, transparent 60%);
            z-index: 1;
        }
        
        .timer-display span {
            position: relative;
            z-index: 2;
        }
        
        .timer-normal {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border-color: #047857;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }
        
        .timer-warning {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            border-color: #d97706;
            animation: timerPulse 1s infinite;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .timer-danger {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            border-color: #dc2626;
            animation: timerPulse 0.5s infinite;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }
        
        .timer-unlimited {
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: white;
            border-color: #0284c7;
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }
        
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6); }
        }
        
        /* „Åù„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥ */
        .timer-btn, .mode-btn, .direction-btn {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-gentle);
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        
        .timer-btn:hover, .mode-btn:hover, .direction-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
        }
        
        .timer-btn.active, .mode-btn.active, .direction-btn.active {
            background: #fefefe;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
        }
        
        /* „ÇØ„Ç§„Ç∫Èñ¢ÈÄ£ */
        .answer-display {
            background: #ffffff;
            border-radius: 16px;
            padding: 2rem;
            margin-top: 1rem;
            margin-bottom: 3rem;
            border: 3px solid var(--border-soft);
            text-align: left;
            font-size: 1.1rem;
            line-height: 1.8;
            box-shadow: 0 4px 12px var(--shadow-gentle);
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }
        
        .answer-display.show {
            border-color: var(--primary-sage);
            background: #fefefe;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.1);
        }
        
        .answer-text {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--primary-sage);
            margin-bottom: 1rem;
            text-align: center;
            width: 100%;
            padding: 1rem;
            background: rgba(5, 150, 105, 0.05);
            border-radius: 12px;
            position: relative;
        }
        
        .explanation-text {
            color: var(--text-dark);
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: left;
            width: 100%;
        }
        
        .show-answer-btn {
            background: var(--primary-sky);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.25);
            margin: 0.5rem 0;
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        
        .show-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.35);
            background: #0284c7;
        }
        
        .show-answer-btn:disabled {
            background: #e2e8f0;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .quiz-question {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.5;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            overflow-wrap: break-word;
            word-wrap: break-word;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* „ÇØ„Ç§„Ç∫„Éò„ÉÉ„ÉÄ„Éº */
        .quiz-header {
            position: sticky;
            top: -1rem;
            background: #ffffff;
            z-index: 10;
            padding: 1rem;
            margin: -1rem -1rem 0 -1rem;
            border-radius: 24px 24px 0 0;
        }
        
        .quiz-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .quiz-title-section {
            flex: 1;
            text-align: center;
        }
        
        .quiz-timer-section {
            flex-shrink: 0;
            margin-left: 1rem;
        }
        
        .quiz-fixed-content {
            position: sticky;
            top: 0;
            background: #ffffff;
            z-index: 9;
            padding-bottom: 1rem;
        }
        
        .quiz-scrollable-content {
            position: relative;
            z-index: 1;
        }
        
        /* „Ç∞„É™„ÉÉ„Éâ */
        .grade-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .lesson-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        
        .grammar-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        /* „Åù„ÅÆ‰ªñ */
        .stats-display {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 6px 20px var(--shadow-gentle);
        }
        
        .section-divider {
            height: 2px;
            background: var(--border-soft);
            margin: 1.25rem 0;
        }
        
        .back-button {
            background: #ffffff;
            border: 3px solid var(--border-soft);
            color: var(--text-dark);
            border-radius: 16px;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.03);
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }
        
        .back-button:hover {
            background: #fefefe;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            animation: particleFloat 2.5s ease-out forwards;
            font-size: 20px;
        }
        
        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-40px) scale(1.3) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* „Çπ„Éë„Éº„ÇØ„É´ */
        .sparkle {
            position: relative;
            overflow: visible;
        }
        
        .sparkle::before,
        .sparkle::after {
            content: '‚ú®';
            position: absolute;
            opacity: 0;
            animation: sparkleFloat 3s infinite ease-in-out;
        }
        
        .sparkle::before {
            top: -10px;
            left: -10px;
            animation-delay: 0s;
        }
        
        .sparkle::after {
            bottom: -10px;
            right: -10px;
            animation-delay: 1.5s;
        }
        
        @keyframes sparkleFloat {
            0%, 100% { opacity: 0; transform: translateY(0) scale(0.8); }
            50% { opacity: 1; transform: translateY(-20px) scale(1.2); }
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 640px) {
            .modal.show {
                padding: 7rem 0.5rem 8rem 0.5rem !important;
            }
            
            #quizModal {
                padding: 5rem 0 8rem 0 !important;
                align-items: center !important;
            }
            
            #quizModal .modal-content {
                width: 98% !important;
                min-width: 280px !important;
                max-width: calc(100vw - 1rem) !important;
                margin: 0 auto !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }
            
            .quiz-card {
                padding: 0.75rem !important;
                margin: 0 !important;
            }
            
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }
            
            .warm-card {
                margin: 0.25rem;
                padding: 1rem;
            }
            
            .game-title {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }
            
            .grade-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
            }
            
            .lesson-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .grammar-grid {
                grid-template-columns: 1fr;
                gap: 0.4rem;
            }
            
            .grade-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }
            
            .lesson-btn {
                padding: 0.6rem 0.4rem;
                min-height: 50px;
                font-size: 0.75rem;
            }
            
            .grammar-btn {
                padding: 0.5rem 0.3rem;
                min-height: 45px;
                font-size: 0.7rem;
            }
            
            .timer-display {
                width: 60px;
                height: 60px;
                font-size: 1.1rem;
            }
            
            .quiz-question {
                font-size: 1rem;
                padding: 1rem;
                min-height: 60px;
            }
            
            .answer-display {
                padding: 1.5rem;
                min-height: 150px;
                max-height: 300px;
                margin-bottom: 4rem;
            }
            
            .answer-text {
                font-size: 1.2rem;
                padding: 0.75rem;
            }
            
            .explanation-text {
                font-size: 1rem;
            }
            
            .fixed-header {
                top: 0.5rem;
                padding: 0.6rem 1.2rem;
                gap: 0.8rem;
            }
            
            .header-stat-item {
                min-width: 50px;
                padding: 0.3rem 0.5rem;
                gap: 0.3rem;
                border-radius: 14px;
            }
            
            .header-stat-number {
                font-size: 0.8rem;
            }
            
            .header-stat-emoji {
                font-size: 0.95rem;
            }
            
            .header-nav-item {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
            
            .voice-gender-btn {
                min-height: 100px;
                padding: 1.25rem 0.75rem;
            }
            
            .voice-gender-icon {
                font-size: 2rem;
            }
            
            .voice-gender-label {
                font-size: 1rem;
            }
            
            .voice-gender-description {
                font-size: 0.8rem;
            }
            
            .action-button-container {
                padding: 1rem 0.75rem;
                margin: -1rem;
                margin-top: 1.5rem;
            }
            
            .quiz-timer-section {
                margin-left: 0.5rem !important;
            }
            
            #currentCategory {
                font-size: 0.75rem !important;
            }
            
            .speak-btn {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
                margin-left: 10px !important;
            }
            
            .text-with-speaker {
                gap: 10px !important;
                min-height: 50px !important;
                padding: 8px !important;
            }
        }
        
        @media (max-width: 480px) {
            #quizModal .modal-content {
                width: 99% !important;
                max-width: calc(100vw - 0.5rem) !important;
            }
            
            .quiz-card {
                padding: 0.5rem !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center gap-6 relative">
    <!-- „É°„Ç§„É≥Â≠¶Âπ¥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="mainGradeModal" class="modal show">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h1 class="game-title sparkle">üéØ NEW CROWN Quiz ‚ö°</h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    üìö Â≠¶Âπ¥„ÇíÈÅ∏Êäû„Åó„Çà„ÅÜ
                </h2>
                <p class="text-gray-600 text-sm mb-4">„ÅÇ„Å™„Åü„ÅÆÂ≠¶Áøí„É¨„Éô„É´„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div class="grid grade-grid mb-6">
                    <button class="grade-btn" data-grade="grade1">
                        <div class="text-3xl mb-1">üî∞</div>
                        <div class="font-semibold text-sm">‰∏≠Â≠¶1Âπ¥Áîü</div>
                    </button>
                    <button class="grade-btn disabled" data-grade="grade2">
                        <div class="text-3xl mb-1">üöß</div>
                        <div class="font-semibold text-sm">‰∏≠Â≠¶2Âπ¥Áîü</div>
                        <div class="coming-soon">Ê∫ñÂÇô‰∏≠</div>
                    </button>
                    <button class="grade-btn disabled" data-grade="grade3">
                        <div class="text-3xl mb-1">üöß</div>
                        <div class="font-semibold text-sm">‰∏≠Â≠¶3Âπ¥Áîü</div>
                        <div class="coming-soon">Ê∫ñÂÇô‰∏≠</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏≠Â≠¶1Âπ¥Áîü„É¨„ÉÉ„Çπ„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="grade1Modal" class="modal">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    üî∞ ‰∏≠Â≠¶1Âπ¥Áîü„ÅÆ„É¨„ÉÉ„Çπ„É≥
                </h2>
                <p class="text-gray-600 text-sm mb-4">Â≠¶Áøí„Åó„Åü„ÅÑ„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div class="grid lesson-grid mb-6" id="grade1Lessons">
                    <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
                
                <div class="action-button-container">
                    <button id="startMultipleLessons1" class="warm-button px-8 py-3 text-sm sparkle w-full" style="display: none;" disabled>
                        üöÄ ÈÅ∏Êäû„Åó„Å¶„É¨„ÉÉ„Çπ„É≥„Çπ„Çø„Éº„ÉàÔºÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏≠Â≠¶2Âπ¥Áîü„É¨„ÉÉ„Çπ„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="grade2Modal" class="modal">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    üöß ‰∏≠Â≠¶2Âπ¥Áîü„ÅÆ„É¨„ÉÉ„Çπ„É≥
                </h2>
                <p class="text-gray-600 text-sm mb-4">ÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div class="grid lesson-grid mb-6" id="grade2Lessons">
                    <div class="p-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">üöß</div>
                        <div class="text-lg font-semibold mb-2">„Ç≥„É≥„ÉÜ„É≥„ÉÑÊ∫ñÂÇô‰∏≠</div>
                        <div class="text-sm">‰∏≠Â≠¶2Âπ¥Áîü„ÅÆÂÜÖÂÆπ„ÅØÁèæÂú®‰ΩúÊàê‰∏≠„Åß„Åô</div>
                    </div>
                </div>
                
                <div class="action-button-container">
                    <button id="startMultipleLessons2" class="warm-button px-8 py-3 text-sm w-full" disabled style="display: none;">
                        üöÄ ÈÅ∏Êäû„Åó„Å¶„É¨„ÉÉ„Çπ„É≥„Çπ„Çø„Éº„ÉàÔºÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏≠Â≠¶3Âπ¥Áîü„É¨„ÉÉ„Çπ„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="grade3Modal" class="modal">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    üöß ‰∏≠Â≠¶3Âπ¥Áîü„ÅÆ„É¨„ÉÉ„Çπ„É≥
                </h2>
                <p class="text-gray-600 text-sm mb-4">ÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div class="grid lesson-grid mb-6" id="grade3Lessons">
                    <div class="p-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">üöß</div>
                        <div class="text-lg font-semibold mb-2">„Ç≥„É≥„ÉÜ„É≥„ÉÑÊ∫ñÂÇô‰∏≠</div>
                        <div class="text-sm">‰∏≠Â≠¶3Âπ¥Áîü„ÅÆÂÜÖÂÆπ„ÅØÁèæÂú®‰ΩúÊàê‰∏≠„Åß„Åô</div>
                    </div>
                </div>
                
                <div class="action-button-container">
                    <button id="startMultipleLessons3" class="warm-button px-8 py-3 text-sm w-full" disabled style="display: none;">
                        üöÄ ÈÅ∏Êäû„Åó„Å¶„É¨„ÉÉ„Çπ„É≥„Çπ„Çø„Éº„ÉàÔºÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊñáÊ≥ïÈ†ÖÁõÆÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="grammarModal" class="modal">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h2 id="grammarModalTitle" class="text-lg font-semibold mb-3 text-gray-700"></h2>
                <p class="text-gray-600 text-sm mb-4">Â≠¶Áøí„Åô„ÇãÂÜÖÂÆπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <!-- ÂÖ®ÈÅ∏Êäû„Éú„Çø„É≥ -->
                <div class="select-all-container">
                    <button id="selectAllGrammarBtn" class="select-all-btn">
                        <span class="select-all-icon">‚òê</span>
                        <span class="select-all-text">„Åô„Åπ„Å¶ÈÅ∏Êäû</span>
                    </button>
                </div>
                
                <div class="grid grammar-grid mb-4" id="grammarCategories">
                    <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
                
                <div class="action-button-container">
                    <button id="startGrammarQuiz" class="warm-button px-8 py-3 text-sm sparkle w-full" disabled>
                        üöÄ „ÇØ„Ç§„Ç∫„Çπ„Çø„Éº„ÉàÔºÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Èü≥Â£∞Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="voiceSettingsModal" class="modal">
        <div class="modal-content">
            <div class="warm-card p-6 text-center">
                <h2 class="text-lg font-semibold mb-4 text-gray-700">
                    üé§ Èü≥Â£∞Ë®≠ÂÆö
                </h2>
                
                <!-- Èü≥Â£∞ON/OFFÂàá„ÇäÊõø„Åà -->
                <div class="voice-toggle">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üîä Èü≥Â£∞Ê©üËÉΩ</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="voiceEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="text-xs text-gray-600 mt-2" id="voiceToggleDescription">Èü≥Â£∞Ê©üËÉΩ„ÅåÊúâÂäπ„Åß„Åô</div>
                </div>
                
                <!-- „Ç∑„É≥„Éó„É´Èü≥Â£∞ÈÅ∏Êäû -->
                <div id="simpleVoiceSelection">
                    <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                </div>
                
                <div class="action-button-container">
                    <button class="warm-button px-6 py-3 text-sm w-full" onclick="closeVoiceSettings()">
                        ‚úÖ Ë®≠ÂÆöÂÆå‰∫Ü
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="gameScreen" class="hidden">
        <div class="warm-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title sparkle">üéØ NEW CROWN Quiz ‚ö°</h1>
            <div id="currentCategory" class="mb-4"></div>
            <div class="stats-display">
                <div class="grid grid-cols-2 gap-4 text-center mb-4">
                    <div>
                        <div class="text-2xl font-bold text-blue-600" id="studyCount">0</div>
                        <div class="text-xs text-gray-600">üìö Â≠¶ÁøíÂõûÊï∞</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600" id="clickCount">0</div>
                        <div class="text-xs text-gray-600">üñ±Ô∏è „Çª„ÉÉ„Ç∑„Éß„É≥</div>
                    </div>
                </div>
                
                <!-- Âà∂ÈôêÊôÇÈñìË®≠ÂÆö -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">‚è∞ Âà∂ÈôêÊôÇÈñìË®≠ÂÆö</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="timer3Btn" class="timer-btn active" data-time="3">
                            ‚ö° 3Áßí
                        </button>
                        <button id="timer5Btn" class="timer-btn" data-time="5">
                            üî• 5Áßí
                        </button>
                        <button id="timer10Btn" class="timer-btn" data-time="10">
                            üåü 10Áßí
                        </button>
                        <button id="timerUnlimitedBtn" class="timer-btn" data-time="unlimited">
                            ‚àû ÁÑ°Âà∂Èôê
                        </button>
                    </div>
                </div>
                
                <!-- Âá∫È°åÂΩ¢ÂºèÈÅ∏Êäû -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">üé≤ Âá∫È°å„Çπ„Çø„Ç§„É´</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                            üéØ „É©„É≥„ÉÄ„É†
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                            üìñ È†ÜÁï™ÈÄö„Çä
                        </button>
                    </div>
                </div>

                <!-- Âá∫È°åÊñπÂêëÈÅ∏Êäû - ‰øÆÊ≠£Áâà -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">üåè Ë®ÄË™ûÊñπÂêë</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="jpToEnBtn" class="direction-btn active" data-direction="jp_to_en">
                            üáØüáµ‚Üíüá∫üá∏<br><small>Êó•‚ÜíËã±</small>
                        </button>
                        <button id="enToJpBtn" class="direction-btn" data-direction="en_to_jp">
                            üá∫üá∏‚ÜíüáØüáµ<br><small>Ëã±‚ÜíÊó•</small>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="mixedBtn" class="direction-btn" data-direction="mixed">
                            üîÄ „Éü„ÉÉ„ÇØ„Çπ„É¢„Éº„Éâ
                        </button>
                    </div>
                </div>
            </div>
            <button id="startQuizButton" class="warm-button px-8 py-4 text-base font-semibold mt-6 sparkle">
                üöÄ „É¨„ÉÉ„ÉÑ„Çπ„Çø„Éº„ÉàÔºÅ
            </button>
        </div>
    </div>

    <!-- „ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´ -->
    <div id="quizModal" class="modal">
        <div class="modal-content">
            <div class="quiz-card">
                <!-- „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜ -->
                <div class="quiz-header">
                    <div class="quiz-header-top">
                        <div class="quiz-title-section">
                            <h2 class="font-semibold text-lg text-gray-700 text-center">
                                üéØ NEW CROWN Quiz Challenge
                            </h2>
                            <div id="remainingCount" class="text-sm text-gray-600 text-center mt-1"></div>
                        </div>
                        <div class="quiz-timer-section">
                            <div id="timerDisplay" class="timer-display timer-normal">
                                <span id="timerValue">Ê∫ñÂÇô‰∏≠</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Âõ∫ÂÆö„Ç≥„É≥„ÉÜ„É≥„ÉÑÈÉ®ÂàÜ -->
                <div class="quiz-fixed-content">
                    <!-- ÂïèÈ°åË°®Á§∫„Ç®„É™„Ç¢ -->
                    <div id="quizQuestion" class="quiz-question"></div>
                    
                    <!-- Ëß£Á≠îË°®Á§∫„Éú„Çø„É≥ -->
                    <div class="text-center">
                        <button id="showAnswerBtn" class="show-answer-btn">
                            üí° Ëß£Á≠î„ÇíË¶ã„Çã
                        </button>
                    </div>
                </div>
                
                <!-- „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç≥„É≥„ÉÜ„É≥„ÉÑÈÉ®ÂàÜ -->
                <div class="quiz-scrollable-content">
                    <div id="answerDisplay" class="answer-display">
                        <div id="answerContent">
                            <div class="text-gray-500" style="text-align: center;">Ëß£Á≠î„ÇíÂ£∞„Å´Âá∫„Åó„Å¶„Åã„ÇâËß£Á≠î„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Å≠ÔºÅ</div>
                        </div>
                    </div>
                    
                    <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
                    <div class="action-button-container">
                        <button id="quizNext" class="warm-button py-3 text-sm w-full" disabled>
                            üåü Ê¨°„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="fixed-header">
        <!-- „Éõ„Éº„É†„Éú„Çø„É≥ -->
        <div class="header-nav-item home" id="footerHomeBtn" title="„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çã">
            üè†
        </div>
        
        <!-- Êàª„Çã„Éú„Çø„É≥ -->
        <div class="header-nav-item back" id="footerBackBtn" title="Ââç„ÅÆÁîªÈù¢„Å´Êàª„Çã">
            ‚óÄÔ∏é
        </div>
        
        <!-- Á∑è„ÇØ„É™„ÉÉ„ÇØÁµ±Ë®à -->
        <div class="header-stat-item" id="footerTotalStat" title="„Çø„ÉÉ„Éó„Åß„É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç">
            <span class="header-stat-emoji">üèÜ</span>
            <span class="header-stat-number" id="footerTotalClick">0</span>
        </div>
        
        <!-- ‰ªäÊó•„ÅÆ„ÇØ„É™„ÉÉ„ÇØÁµ±Ë®à -->
        <div class="header-stat-item" id="footerTodayStat" title="„Çø„ÉÉ„Éó„Åß„É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç">
            <span class="header-stat-emoji">üìÖ</span>
            <span class="header-stat-number" id="footerTodayClick">0</span>
        </div>
        
        <!-- Èü≥Â£∞Ë®≠ÂÆö„Éú„Çø„É≥ -->
        <div class="header-nav-item voice" id="footerVoiceBtn" title="Èü≥Â£∞Ë®≠ÂÆö">
            üé§
        </div>
    </div>

<!-- problems.jsË™≠„ÅøËæº„Åø -->
<script src="problems.js"></script>

<script>
        /* „É¨„ÉÉ„Çπ„É≥„ÉªÊñáÊ≥ïÈ†ÖÁõÆÂÆöÁæ© - NEW CROWNÁâà„ÅÆ„É¨„ÉÉ„Çπ„É≥ÂÜÖÂÆπ */
        const lessons = {
            grade1: [
                {
                    id: 'lesson1',
                    name: 'Lesson1 - Ëá™Â∑±Á¥π‰ªã„Å®Âü∫Êú¨Ë°®Áèæ',
                    grammar: [
                        {id: 'lesson1_part1_scene1', name: 'Part1 Scene1 - Âü∫Êú¨„ÅÆË°®Áèæ'},
                        {id: 'lesson1_part1_scene2', name: 'Part1 Scene2 - Ë©≥„Åó„ÅÑËá™Â∑±Á¥π‰ªã'},
                        {id: 'lesson1_part2_scene1', name: 'Part2 Scene1 - ÁñëÂïèÊñá'},
                        {id: 'lesson1_part2_scene2', name: 'Part2 Scene2 - „ÇØ„É©„ÉñÊ¥ªÂãï'},
                        {id: 'lesson1_part3_scene1', name: 'Part3 Scene1 - WhatÁñëÂïèÊñá'},
                        {id: 'lesson1_part3_scene2', name: 'Part3 Scene2 - ÂÜôÁúü„Å®ÂãïÁâ©'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - ËÉΩÂäõ„Å®‰∫∫Áâ©Á¥π‰ªã',
                    grammar: [
                        {id: 'lesson2_part1_scene1', name: 'Part1 Scene1 - ‰∫∫Áâ©Á¥π‰ªã'},
                        {id: 'lesson2_part1_scene2', name: 'Part1 Scene2 - „Éí„Éº„É≠„ÉºÁ¥π‰ªã'},
                        {id: 'lesson2_part2_scene1', name: 'Part2 Scene1 - CanÁñëÂïèÊñá'},
                        {id: 'lesson2_part2_scene2', name: 'Part2 Scene2 - Â∞ÜÊ£ã„ÇíÊïô„Åà„Çã'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - Áâ©„ÅÆÁ¥π‰ªã„Å®ÁñëÂïèË°®Áèæ',
                    grammar: [
                        {id: 'lesson3_part1_scene1', name: 'Part1 Scene1 - This/That'},
                        {id: 'lesson3_part1_scene2', name: 'Part1 Scene2 - Á•ûÁ§æË¶ãÂ≠¶'},
                        {id: 'lesson3_part2_scene1', name: 'Part2 Scene1 - WhatÁñëÂïèÊñáÂøúÁî®'},
                        {id: 'lesson3_part2_scene2', name: 'Part2 Scene2 - „Ç∑„Çø„Éº„É´Á¥π‰ªã'},
                        {id: 'lesson3_part3_scene1', name: 'Part3 Scene1 - Êº´Áîª„Ç≠„É£„É©„ÇØ„Çø„Éº'}
                    ]
                },
                {
                    id: 'language_focus1',
                    name: 'Language Focus1 - ÊñáÊ≥ïÂü∫Á§é',
                    grammar: [
                        {id: 'language_focus1_word_order', name: 'Ë™ûÈ†Ü„Å®Êñá„ÅÆÁ®ÆÈ°û'},
                        {id: 'language_focus1_sentence_types', name: 'Êñá„ÅÆÁ®ÆÈ°û'},
                        {id: 'language_focus1_nouns', name: 'ÂêçË©û„ÅÆ‰Ωø„ÅÑÊñπ'}
                    ]
                },
                {
                    id: 'language_focus2',
                    name: 'Language Focus2 - ÂãïË©û„Å®Âä©ÂãïË©û',
                    grammar: [
                        {id: 'language_focus2_be_verb', name: 'beÂãïË©û'},
                        {id: 'language_focus2_general_verbs', name: '‰∏ÄËà¨ÂãïË©û'},
                        {id: 'language_focus2_lets_imperative', name: 'Let\'s „Å®ÂëΩ‰ª§Êñá'},
                        {id: 'language_focus2_can', name: 'can „ÅÆ‰Ωø„ÅÑÊñπ'},
                        {id: 'language_focus2_question_words', name: 'ÁñëÂïèË©û'}
                    ]
                },
                {
                    id: 'take_action_talk1',
                    name: 'Take Action! Talk1 - ÂÆüË∑µ‰ºöË©±',
                    grammar: [
                        {id: 'take_action_talk1', name: 'ÈÅìÊ°àÂÜÖ„ÅÆ‰ºöË©±'}
                    ]
                },
                {
                    id: 'comprehensive_practice',
                    name: 'Á∑èÂêàÁ∑¥ÁøíÂïèÈ°å',
                    grammar: [
                        {id: 'comprehensive_practice', name: 'Á∑èÂêàÁ∑¥Áøí'}
                    ]
                }
            ],
            grade2: [],
            grade3: []
        };

        /* „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ */
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initAudio();
            }
            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            }
            playClick() {
                if (!this.audioContext) return;
                try {
                    this.createBell(660, 0.08, 0.15);
                } catch (e) {
                    console.log('„ÇØ„É™„ÉÉ„ÇØÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            playStudyComplete() {
                if (!this.audioContext) return;
                try {
                    this.createSoftTone(440, 0.25, 0.2);
                } catch (e) {
                    console.log('ÂÆå‰∫ÜÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            playSuccess() {
                if (!this.audioContext) return;
                try {
                    this.createSoftTone(523, 0.15, 0.18);
                } catch (e) {
                    console.log('ÊàêÂäüÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            playTick() {
                if (!this.audioContext) return;
                try {
                    this.createBell(800, 0.05, 0.1);
                } catch (e) {
                    console.log('„ÉÅ„ÉÉ„ÇØÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            playTimeUp() {
                if (!this.audioContext) return;
                try {
                    this.createWarmTone(220, 0.4, 0.3);
                } catch (e) {
                    console.log('ÊôÇÈñìÂàá„ÇåÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
            createBell(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
            createSoftTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'triangle';
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
            createWarmTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ
        class VoiceSystem {
            constructor() {
                this.synth = null;
                this.voices = [];
                this.selectedVoice = null;
                this.isEnabled = true;
                this.deviceType = this.detectDevice();
                this.browserType = this.detectBrowser();
                this.currentMaleVoice = null;
                this.currentFemaleVoice = null;
                this.initializationAttempts = 0;
                this.maxInitializationAttempts = 10;
                this.isInitialized = false;
                
                console.log('üé§ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
                
                try {
                    if ('speechSynthesis' in window) {
                        this.synth = window.speechSynthesis;
                        this.initializeVoices();
                        this.ensureAudioContext();
                    } else {
                        console.log('‚ùå Èü≥Â£∞ÂêàÊàê„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }
                } catch (e) {
                    console.error('‚ùå Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }

            // Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÁ¢∫‰øùÔºàÂº∑ÂåñÁâàÔºâ
            ensureAudioContext() {
                let activated = false;
                
                const activateAudio = () => {
                    if (activated) return;
                    activated = true;
                    
                    try {
                        if (this.synth) {
                            // Áü≠ÊôÇÈñì„ÅÆÁÑ°Èü≥„ÇíÂÜçÁîü„Åó„Å¶Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÇíÊ¥ªÊÄßÂåñ
                            const utterance = new SpeechSynthesisUtterance('');
                            utterance.volume = 0;
                            utterance.rate = 10;
                            this.synth.speak(utterance);
                            
                            setTimeout(() => {
                                this.synth.cancel();
                            }, 100);
                            
                            console.log('üé§ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Ê¥ªÊÄßÂåñÂÆå‰∫Ü');
                        }
                    } catch (e) {
                        console.log('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Ê¥ªÊÄßÂåñ„Å´Â§±Êïó:', e);
                    }
                };
                
                // Ë§áÊï∞„ÅÆ„Ç§„Éô„É≥„Éà„ÅßÊ¥ªÊÄßÂåñ„ÇíË©¶Ë°å
                const events = ['click', 'touchstart', 'touchend', 'mousedown', 'keydown'];
                events.forEach(eventType => {
                    document.addEventListener(eventType, activateAudio, {once: true, passive: true});
                });
                
                // „Çø„Ç§„Éû„Éº„Åß„ÇÇË©¶Ë°å
                setTimeout(activateAudio, 1000);
            }

            detectDevice() {
                const userAgent = navigator.userAgent.toLowerCase();
                const platform = navigator.platform.toLowerCase();
                
                if (/iphone/.test(userAgent)) {
                    return 'iphone';
                } else if (/ipad/.test(userAgent)) {
                    return 'ipad';
                } else if (/ipod/.test(userAgent)) {
                    return 'ipod';
                } else if (platform.includes('mac')) {
                    return 'mac';
                } else if (/android/.test(userAgent)) {
                    if (/mobile/.test(userAgent)) {
                        return 'android_phone';
                    } else {
                        return 'android_tablet';
                    }
                } else if (/windows/.test(userAgent) || platform.includes('win')) {
                    return 'windows';
                } else if (/linux/.test(userAgent) || platform.includes('linux')) {
                    return 'linux';
                } else {
                    return 'other';
                }
            }

            detectBrowser() {
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (/chrome/.test(userAgent) && !/edg/.test(userAgent)) {
                    return 'chrome';
                } else if (/safari/.test(userAgent) && !/chrome/.test(userAgent)) {
                    return 'safari';
                } else if (/firefox/.test(userAgent)) {
                    return 'firefox';
                } else if (/edg/.test(userAgent)) {
                    return 'edge';
                } else {
                    return 'other';
                }
            }

            initializeVoices() {
                this.initializationAttempts++;
                
                if (this.initializationAttempts > this.maxInitializationAttempts) {
                    console.log('‚ö†Ô∏è Èü≥Â£∞ÂàùÊúüÂåñ„ÅÆÊúÄÂ§ßË©¶Ë°åÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü');
                    return;
                }
                
                console.log(`üîÑ Èü≥Â£∞ÂàùÊúüÂåñË©¶Ë°å ${this.initializationAttempts}ÂõûÁõÆ`);
                
                this.loadVoices();
                
                if (this.synth && this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => {
                        console.log('üîÑ Èü≥Â£∞„É™„Çπ„ÉàÂ§âÊõ¥„Ç§„Éô„É≥„ÉàÁô∫Áîü');
                        this.loadVoices();
                    };
                }

                // „Çà„ÇäÁ©çÊ•µÁöÑ„Å™ÂÜçË©¶Ë°å„Çπ„Ç±„Ç∏„É•„Éº„É´
                const retryIntervals = [50, 150, 300, 600, 1000, 2000, 3000, 5000, 8000, 12000];
                retryIntervals.forEach((delay, index) => {
                    setTimeout(() => {
                        if (!this.isInitialized && this.initializationAttempts <= this.maxInitializationAttempts) {
                            console.log(`üîÑ Èü≥Â£∞ÂÜçË©¶Ë°å ${index + 1}ÂõûÁõÆ (${delay}msÂæå)`);
                            this.loadVoices();
                        }
                    }, delay);
                });
            }

            loadVoices() {
                if (!this.synth) return;
                
                try {
                    const allVoices = this.synth.getVoices();
                    console.log(`üé§ ÂÖ®Èü≥Â£∞ÂèñÂæó: ${allVoices.length}ÂÄã`);
                    
                    if (allVoices.length === 0) {
                        console.log('‚ö†Ô∏è Èü≥Â£∞„É™„Çπ„Éà„ÅåÁ©∫„Åß„Åô„ÄÇÂÜçË©¶Ë°å„Åó„Åæ„Åô...');
                        return;
                    }
                    
                    this.voices = allVoices.filter(voice => {
                        const lang = voice.lang.toLowerCase();
                        return lang.startsWith('en') || lang.includes('english');
                    });
                    
                    console.log(`üîç Ëã±Ë™ûÈü≥Â£∞„Éï„Ç£„É´„ÇøÁµêÊûú: ${this.voices.length}ÂÄã`);
                    
                    if (this.voices.length > 0) {
                        this.setDeviceRecommendedVoices();
                        this.loadSettings();
                        this.isInitialized = true;
                        
                        console.log('‚úÖ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
                        console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÈü≥Â£∞:', this.selectedVoice?.name || '„Å™„Åó');
                        
                        // ÂàùÊúüÂåñÂÆå‰∫Ü„ÅÆÈÄöÁü•
                        this.onInitialized();
                    } else {
                        console.log('‚ö†Ô∏è Ëã±Ë™ûÈü≥Â£∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                } catch (e) {
                    console.error('‚ùå Èü≥Â£∞„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }
            
            onInitialized() {
                console.log('üéâ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫ÜÈÄöÁü•');
                // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´
                const event = new CustomEvent('voiceSystemReady', {
                    detail: {
                        voices: this.voices.length,
                        selectedVoice: this.selectedVoice?.name
                    }
                });
                document.dispatchEvent(event);
            }

            getDeviceVoiceRecommendations() {
                const baseRecommendations = {
                    iphone: {
                        male: ['Daniel', 'Alex', 'Aaron', 'Fred', 'Tom', 'Arthur', 'Ralph'],
                        female: ['Samantha', 'Victoria', 'Karen', 'Susan', 'Allison', 'Ava', 'Kathy', 'Melina']
                    },
                    ipad: {
                        male: ['Alex', 'Daniel', 'Aaron', 'Fred', 'Tom', 'Arthur', 'Ralph'],
                        female: ['Samantha', 'Victoria', 'Karen', 'Susan', 'Allison', 'Ava', 'Kathy']
                    },
                    mac: {
                        male: ['Alex', 'Daniel', 'Aaron', 'Fred', 'Tom', 'Arthur', 'Ralph', 'Junior'],
                        female: ['Samantha', 'Victoria', 'Karen', 'Susan', 'Allison', 'Ava', 'Kathy', 'Melina', 'Fiona']
                    },
                    android_phone: {
                        male: [
                            'Male', 
                            'en-us-x-sfg#male_1-local', 'en-us-x-sfg#male_2-local', 'en-us-x-sfg#male_3-local',
                            'English (United States) Male',
                            'Google US English Male',
                            'Samsung Male',
                            'English (US) Male Voice'
                        ],
                        female: [
                            'Female',
                            'en-us-x-sfg#female_1-local', 'en-us-x-sfg#female_2-local', 'en-us-x-sfg#female_3-local',
                            'English (United States) Female',
                            'Google US English Female',
                            'Samsung Female',
                            'English (US) Female Voice'
                        ]
                    },
                    android_tablet: {
                        male: [
                            'Male',
                            'en-us-x-sfg#male_1-local', 'en-us-x-sfg#male_2-local',
                            'Google US English Male',
                            'English (United States) Male'
                        ],
                        female: [
                            'Female',
                            'en-us-x-sfg#female_1-local', 'en-us-x-sfg#female_2-local',
                            'Google US English Female',
                            'English (United States) Female'
                        ]
                    },
                    windows: {
                        male: ['Microsoft David', 'Microsoft Mark', 'David', 'Mark', 'Microsoft George', 'Microsoft Guy'],
                        female: ['Microsoft Zira', 'Microsoft Hazel', 'Zira', 'Hazel', 'Microsoft Helen', 'Microsoft Eva']
                    },
                    linux: {
                        male: ['Male', 'English (US) Male', 'espeak', 'festival male', 'Google US English Male'],
                        female: ['Female', 'English (US) Female', 'espeak female', 'festival female', 'Google US English Female']
                    },
                    other: {
                        male: ['Male', 'Alex', 'Google US English', 'English Male', 'Default Male', 'Daniel'],
                        female: ['Female', 'Samantha', 'Google US English', 'English Female', 'Default Female', 'Victoria']
                    }
                };

                const browserAdjustments = {
                    chrome: {
                        malePrefix: ['Google US English Male', 'Chrome OS US English Male'],
                        femalePrefix: ['Google US English Female', 'Chrome OS US English Female']
                    },
                    safari: {
                        malePrefix: ['Alex', 'Daniel', 'Aaron'],
                        femalePrefix: ['Samantha', 'Victoria', 'Susan']
                    },
                    firefox: {
                        malePrefix: ['Male', 'English (US) Male'],
                        femalePrefix: ['Female', 'English (US) Female']
                    },
                    edge: {
                        malePrefix: ['Microsoft David', 'Microsoft Mark'],
                        femalePrefix: ['Microsoft Zira', 'Microsoft Hazel']
                    }
                };

                let recommendations = baseRecommendations[this.deviceType] || baseRecommendations.other;

                if (browserAdjustments[this.browserType]) {
                    const browserAdj = browserAdjustments[this.browserType];
                    recommendations = {
                        male: [...browserAdj.malePrefix, ...recommendations.male],
                        female: [...browserAdj.femalePrefix, ...recommendations.female]
                    };
                }

                return recommendations;
            }

            setDeviceRecommendedVoices() {
                const recommendations = this.getDeviceVoiceRecommendations();
                
                this.currentMaleVoice = this.findBestVoice(recommendations.male);
                this.currentFemaleVoice = this.findBestVoice(recommendations.female);
                
                console.log('üéØ Êé®Â•®Èü≥Â£∞Ë®≠ÂÆö:', {
                    device: this.deviceType,
                    browser: this.browserType,
                    male: this.currentMaleVoice?.name,
                    female: this.currentFemaleVoice?.name
                });
                
                if (!this.selectedVoice) {
                    this.selectedVoice = this.currentFemaleVoice || this.currentMaleVoice || this.voices[0];
                }
            }

            findBestVoice(candidateNames) {
                for (const name of candidateNames) {
                    const voice = this.voices.find(v => 
                        v.name.toLowerCase().includes(name.toLowerCase()) ||
                        name.toLowerCase().includes(v.name.toLowerCase())
                    );
                    if (voice) {
                        return voice;
                    }
                }
                return null;
            }

            selectGenderVoice(gender) {
                let targetVoice = null;
                
                if (gender === 'male') {
                    targetVoice = this.currentMaleVoice;
                } else if (gender === 'female') {
                    targetVoice = this.currentFemaleVoice;
                }
                
                if (targetVoice) {
                    this.selectedVoice = targetVoice;
                    this.saveSettings();
                    this.updateVoiceSelectionUI(gender);
                    console.log(`üé§ Èü≥Â£∞ÈÅ∏Êäû: ${gender} - ${targetVoice.name}`);
                    return true;
                }
                return false;
            }

            updateVoiceSelectionUI(selectedGender) {
                document.querySelectorAll('.voice-gender-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                const targetBtn = document.querySelector(`[data-voice-gender="${selectedGender}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('selected');
                }
            }

            testVoice(gender) {
                const deviceMessages = {
                    iphone: {
                        male: "Hello! I'm optimized for your iPhone. Let's practice NEW CROWN English together!",
                        female: "Hi there! I'm your iPhone NEW CROWN learning companion. Ready to improve?"
                    },
                    ipad: {
                        male: "Greetings! I'm designed for your iPad's excellent speakers. Let's learn NEW CROWN!",
                        female: "Hello! Your iPad and I make a perfect NEW CROWN learning team. Let's get started!"
                    },
                    android_phone: {
                        male: "Hi! I'm the best voice for your Android phone. Ready for NEW CROWN practice?",
                        female: "Hello! I'm optimized for Android devices. Let's master NEW CROWN together!"
                    },
                    android_tablet: {
                        male: "Hello! I work great on your Android tablet. Let's start NEW CROWN learning!",
                        female: "Hi there! Your Android tablet and I are ready for NEW CROWN lessons!"
                    },
                    windows: {
                        male: "Hello! I'm the Windows voice assistant for your NEW CROWN learning journey.",
                        female: "Hi! I'm here to help you learn NEW CROWN English on your Windows computer."
                    },
                    mac: {
                        male: "Hello! I'm the Mac voice optimized for clear NEW CROWN pronunciation.",
                        female: "Hi there! I'm your Mac's NEW CROWN English learning voice assistant."
                    },
                    linux: {
                        male: "Hello! I'm working on your Linux system to help you learn NEW CROWN English.",
                        female: "Hi! I'm the Linux voice ready to assist your NEW CROWN studies."
                    },
                    other: {
                        male: "Hello! I'm here to help you practice NEW CROWN English pronunciation clearly.",
                        female: "Hi there! I'm ready to be your NEW CROWN English learning voice companion."
                    }
                };
                
                const messages = deviceMessages[this.deviceType] || deviceMessages.other;
                const testText = messages[gender];
                
                if (gender === 'male' && this.currentMaleVoice) {
                    this.testSpecificVoice(this.currentMaleVoice, testText);
                } else if (gender === 'female' && this.currentFemaleVoice) {
                    this.testSpecificVoice(this.currentFemaleVoice, testText);
                }
            }

            testSpecificVoice(voice, text) {
                try {
                    if (this.synth) {
                        this.synth.cancel();
                    }
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.voice = voice;
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.9;
                    
                    console.log(`üîä Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÆüË°å: ${voice.name}`);
                    if (this.synth) {
                        this.synth.speak(utterance);
                    }
                } catch (e) {
                    console.error('‚ùå Èü≥Â£∞„ÉÜ„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }

            // **ÈáçË¶Å‰øÆÊ≠£: Èü≥Â£∞ÂÜçÁîü„ÅÆÂÆåÂÖ®‰øÆÊ≠£Áâà**
            speak(text) {
                return new Promise((resolve, reject) => {
                    if (!this.isEnabled || !text.trim() || !this.synth) {
                        console.log('‚ùå Èü≥Â£∞ÂÜçÁîü„Çπ„Ç≠„ÉÉ„Éó:', {
                            isEnabled: this.isEnabled,
                            hasText: !!text.trim(),
                            hasSynth: !!this.synth
                        });
                        resolve();
                        return;
                    }
                    
                    try {
                        // Êó¢Â≠ò„ÅÆÈü≥Â£∞„ÇíÂÅúÊ≠¢
                        this.synth.cancel();
                        
                        const cleanText = this.cleanEnglishText(text);
                        if (!cleanText) {
                            console.log('‚ùå „ÇØ„É™„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅåÁ©∫');
                            resolve();
                            return;
                        }
                        
                        const utterance = new SpeechSynthesisUtterance(cleanText);
                        
                        if (this.selectedVoice) {
                            utterance.voice = this.selectedVoice;
                        }
                        
                        utterance.rate = 0.8;   // Â∞ë„ÅóÈÅÖ„ÇÅ„Å´Ë®≠ÂÆö
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0; // ÊúÄÂ§ßÈü≥Èáè
                        
                        console.log('üîä Èü≥Â£∞ÂÜçÁîüÂÆüË°å:', {
                            text: cleanText,
                            voice: this.selectedVoice?.name || '„Éá„Éï„Ç©„É´„Éà',
                            rate: utterance.rate,
                            volume: utterance.volume
                        });
                        
                        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºË®≠ÂÆö
                        utterance.onstart = () => {
                            console.log('üîä Èü≥Â£∞ÂÜçÁîüÈñãÂßã');
                        };
                        
                        utterance.onend = () => {
                            console.log('üîä Èü≥Â£∞ÂÜçÁîüÁµÇ‰∫Ü');
                            resolve();
                        };
                        
                        utterance.onerror = (event) => {
                            console.error('üîä Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', event.error);
                            reject(event.error);
                        };
                        
                        // Èü≥Â£∞ÂÜçÁîüÂÆüË°å
                        this.synth.speak(utterance);
                        
                        // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà10ÁßíÔºâ
                        setTimeout(() => {
                            if (this.synth.speaking) {
                                this.synth.cancel();
                                console.log('‚è∞ Èü≥Â£∞ÂÜçÁîü„Çø„Ç§„É†„Ç¢„Ç¶„Éà');
                                resolve();
                            }
                        }, 10000);
                        
                    } catch (e) {
                        console.error('‚ùå Èü≥Â£∞ÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                        reject(e);
                    }
                });
            }

            cleanEnglishText(text) {
                return text
                    .replace(/[^\w\s.!?',\-]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            setEnabled(enabled) {
                this.isEnabled = enabled;
                this.saveSettings();
                
                console.log('üîä Èü≥Â£∞Ê©üËÉΩ:', enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ');
                
                if (!enabled && this.synth) {
                    try {
                        this.synth.cancel();
                    } catch (e) {
                        console.log('Èü≥Â£∞ÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                    }
                }
            }

            saveSettings() {
                try {
                    const settings = {
                        voiceName: this.selectedVoice ? this.selectedVoice.name : null,
                        isEnabled: this.isEnabled,
                        deviceType: this.deviceType,
                        browserType: this.browserType
                    };
                    localStorage.setItem('newCrownQuizVoiceSettings', JSON.stringify(settings));
                } catch (e) {
                    console.log('Èü≥Â£∞Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('newCrownQuizVoiceSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.isEnabled = settings.isEnabled !== false;
                        
                        if (settings.voiceName && this.voices.length > 0) {
                            const savedVoice = this.voices.find(v => v.name === settings.voiceName);
                            if (savedVoice) {
                                this.selectedVoice = savedVoice;
                                const gender = (savedVoice === this.currentMaleVoice) ? 'male' : 'female';
                                this.updateVoiceSelectionUI(gender);
                            }
                        }
                    }
                } catch (e) {
                    console.log('Èü≥Â£∞Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }

            getSelectedVoiceName() {
                return this.selectedVoice ? this.selectedVoice.name : '„Éá„Éï„Ç©„É´„Éà';
            }

            getDeviceInfo() {
                const deviceNames = {
                    iphone: 'iPhone',
                    ipad: 'iPad',
                    ipod: 'iPod',
                    mac: 'Mac',
                    android_phone: 'Android„Çπ„Éû„Éõ',
                    android_tablet: 'Android„Çø„Éñ„É¨„ÉÉ„Éà',
                    windows: 'Windows PC',
                    linux: 'Linux PC',
                    other: '„Åù„ÅÆ‰ªñ„Éá„Éê„Ç§„Çπ'
                };

                const browserNames = {
                    chrome: 'Google Chrome',
                    safari: 'Safari',
                    firefox: 'Firefox',
                    edge: 'Microsoft Edge',
                    other: '„Åù„ÅÆ‰ªñ„Éñ„É©„Ç¶„Ç∂'
                };
                
                return {
                    type: this.deviceType,
                    typeName: deviceNames[this.deviceType] || '„Åù„ÅÆ‰ªñ',
                    browser: this.browserType,
                    browserName: browserNames[this.browserType] || '„Åù„ÅÆ‰ªñ',
                    totalVoices: this.voices.length,
                    maleVoice: this.currentMaleVoice?.name || '„Å™„Åó',
                    femaleVoice: this.currentFemaleVoice?.name || '„Å™„Åó',
                    selectedVoice: this.selectedVoice?.name || '„Å™„Åó',
                    isInitialized: this.isInitialized
                };
            }
        }

        let soundSystem, voiceSystem;
        try {
            soundSystem = new SoundSystem();
            voiceSystem = new VoiceSystem();
        } catch (e) {
            console.error('‚ùå „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            soundSystem = { playClick: () => {}, playStudyComplete: () => {}, playSuccess: () => {}, playTick: () => {}, playTimeUp: () => {} };
            voiceSystem = { speak: () => Promise.resolve(), selectGenderVoice: () => false, testVoice: () => {}, setEnabled: () => {}, isEnabled: true };
        }

        /* „Ç≤„Éº„É†Â§âÊï∞ */
        let selectedGrammarItems = [];
        let selectedLessons = [];
        let currentQuestionIndex = 0;
        let studyCount = 0;
        let sessionClickCount = 0;
        let usedQuestions = [];
        let particleOffset = 0;
        let currentGrade = '';
        let currentLesson = '';
        let questionMode = 'random';
        let sequentialIndex = 0;
        let questionDirection = 'jp_to_en';
        let timerLimit = 3;
        let timerInterval = null;
        let currentTimerValue = 0;
        let isTimerRunning = false;
        let isQuizAnswered = false;
        let allQuestions = [];
        let currentScreen = 'main';
        let isAllSelected = false;

        /* „ÇØ„É™„ÉÉ„ÇØÊï∞ÁÆ°ÁêÜÊ©üËÉΩ */
        let clickStats = { total: 0, daily: {} };

        function getTodayDateString() {
            const today = new Date();
            return today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
        }

        function incrementClickCount() {
            const today = getTodayDateString();
            
            clickStats.total++;
            sessionClickCount++;
            
            if (!clickStats.daily[today]) {
                clickStats.daily[today] = 0;
            }
            clickStats.daily[today]++;
            
            updateClickDisplays();
            saveClickStats();
            
            if (clickStats.total % 10 === 0) {
                createParticle('‚ú®', '#7c3aed', window.innerWidth / 2, window.innerHeight / 2);
            }
            
            if (clickStats.total % 100 === 0) {
                soundSystem.playSuccess();
                createParticle('üèÜ', '#f59e0b', window.innerWidth / 2, window.innerHeight / 2);
            }
            
            return true;
        }

        function updateClickDisplays() {
            try {
                const today = getTodayDateString();
                const todayClicks = clickStats.daily[today] || 0;
                
                const headerTotalElement = document.getElementById('footerTotalClick');
                const headerTodayElement = document.getElementById('footerTodayClick');
                const sessionElement = document.getElementById('clickCount');
                
                if (headerTotalElement) {
                    headerTotalElement.textContent = clickStats.total;
                }
                if (headerTodayElement) {
                    headerTodayElement.textContent = todayClicks;
                }
                if (sessionElement) {
                    sessionElement.textContent = sessionClickCount;
                }
                
            } catch (e) {
                console.log('„ÇØ„É™„ÉÉ„ÇØË°®Á§∫Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function saveClickStats() {
            try {
                localStorage.setItem('newCrownQuizClickStats', JSON.stringify(clickStats));
            } catch (e) {
                console.log('„ÇØ„É™„ÉÉ„ÇØÁµ±Ë®à„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function loadClickStats() {
            try {
                const saved = localStorage.getItem('newCrownQuizClickStats');
                if (saved) {
                    clickStats = JSON.parse(saved);
                    updateClickDisplays();
                }
            } catch (e) {
                console.log('„ÇØ„É™„ÉÉ„ÇØÁµ±Ë®à„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                clickStats = { total: 0, daily: {} };
            }
        }

        function confirmResetTotal() {
            if (confirm('üèÜ Á∑è„ÇØ„É™„ÉÉ„ÇØÊï∞„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºâ')) {
                clickStats.total = 0;
                saveClickStats();
                updateClickDisplays();
                soundSystem.playClick();
            }
        }

        function confirmResetToday() {
            if (confirm('üìÖ ‰ªäÊó•„ÅÆ„ÇØ„É™„ÉÉ„ÇØÊï∞„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºâ')) {
                const today = getTodayDateString();
                clickStats.daily[today] = 0;
                saveClickStats();
                updateClickDisplays();
                soundSystem.playClick();
            }
        }

        /* „Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞ */
        function createParticle(text, color, x, y) {
            try {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = text;
                particle.style.color = color;
                particle.style.left = (x + particleOffset) + 'px';
                particle.style.top = (y + particleOffset) + 'px';
                particle.style.fontSize = '20px';
                document.body.appendChild(particle);

                particleOffset += 40;
                if (particleOffset > 160) particleOffset = 0;

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2500);
            } catch (e) {
                console.log('„Éë„Éº„ÉÜ„Ç£„ÇØ„É´‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ËøΩÂä†Èñ¢Êï∞„ÅÆÂÆåÂÖ®‰øÆÊ≠£Áâà** */
        function addSpeakButton(text) {
            try {
                const englishRegex = /[a-zA-Z]/;
                if (!englishRegex.test(text)) {
                    console.log('üìù Ëã±Ë™û„ÉÜ„Ç≠„Çπ„Éà„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥„Çπ„Ç≠„ÉÉ„Éó:', text);
                    return text;
                }
                
                console.log('üîä „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ËøΩÂä†ÈñãÂßã:', text);
                
                // DOMË¶ÅÁ¥†„Çí‰ΩúÊàê
                const wrapper = document.createElement('div');
                wrapper.className = 'text-with-speaker';
                
                const textContent = document.createElement('span');
                textContent.className = 'text-content';
                textContent.textContent = text;
                
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn';
                speakBtn.innerHTML = 'üîä';
                speakBtn.title = 'Ëã±Ë™û„ÅßË™≠„Åø‰∏ä„Åí';
                speakBtn.type = 'button';
                
                // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                speakBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('üîä „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ:', text);
                    speakEnglishText(text, speakBtn);
                });
                
                wrapper.appendChild(textContent);
                wrapper.appendChild(speakBtn);
                
                console.log('‚úÖ „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥‰ΩúÊàêÂÆå‰∫Ü');
                return wrapper;
                
            } catch (e) {
                console.error('‚ùå „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ËøΩÂä†„Ç®„É©„Éº:', e);
                return text;
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: Èü≥Â£∞ÂÜçÁîüÈñ¢Êï∞„ÅÆÂÆåÂÖ®‰øÆÊ≠£Áâà** */
        async function speakEnglishText(text, button = null) {
            try {
                console.log('üîä Èü≥Â£∞ÂÜçÁîüÈñãÂßã:', text);
                
                if (!voiceSystem.isEnabled) {
                    console.log('‚ùå Èü≥Â£∞Ê©üËÉΩ„ÅåÁÑ°Âäπ');
                    alert('Èü≥Â£∞Ê©üËÉΩ„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ„Éò„ÉÉ„ÉÄ„Éº„ÅÆüé§„Éú„Çø„É≥„Åã„ÇâÈü≥Â£∞Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                if (!text || !text.trim()) {
                    console.log('‚ùå „ÉÜ„Ç≠„Çπ„Éà„ÅåÁ©∫');
                    return;
                }
                
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖãÂ§âÊõ¥
                if (button) {
                    button.classList.add('speaking');
                    button.style.backgroundColor = '#f59e0b';
                    button.innerHTML = 'üîä';
                }
                
                try {
                    // Èü≥Â£∞ÂÜçÁîüÂÆüË°å
                    await voiceSystem.speak(text);
                    console.log('‚úÖ Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü');
                } catch (error) {
                    console.error('‚ùå Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', error);
                    alert('Èü≥Â£∞ÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } finally {
                    // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                    if (button) {
                        button.classList.remove('speaking');
                        button.style.backgroundColor = '#059669';
                    }
                }
                
            } catch (e) {
                console.error('‚ùå Èü≥Â£∞ÂÜçÁîüÂ§±Êïó:', e);
                if (button) {
                    button.classList.remove('speaking');
                    button.style.backgroundColor = '#059669';
                }
                alert('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        /* ÂÖ®ÈÅ∏ÊäûÊ©üËÉΩ */
        function toggleSelectAllGrammar() {
            try {
                incrementClickCount();
                soundSystem.playClick();
                
                const grammarButtons = document.querySelectorAll('#grammarCategories .grammar-btn');
                const selectAllBtn = document.getElementById('selectAllGrammarBtn');
                const selectAllIcon = selectAllBtn.querySelector('.select-all-icon');
                const selectAllText = selectAllBtn.querySelector('.select-all-text');
                
                if (!isAllSelected) {
                    // ÂÖ®ÈÅ∏Êäû
                    grammarButtons.forEach(btn => {
                        if (!btn.classList.contains('selected')) {
                            btn.click();
                        }
                    });
                    
                    isAllSelected = true;
                    selectAllBtn.classList.add('active');
                    selectAllIcon.textContent = '‚òë';
                    selectAllText.textContent = '„Åô„Åπ„Å¶Ëß£Èô§';
                    
                } else {
                    // ÂÖ®Ëß£Èô§
                    grammarButtons.forEach(btn => {
                        if (btn.classList.contains('selected')) {
                            btn.click();
                        }
                    });
                    
                    isAllSelected = false;
                    selectAllBtn.classList.remove('active');
                    selectAllIcon.textContent = '‚òê';
                    selectAllText.textContent = '„Åô„Åπ„Å¶ÈÅ∏Êäû';
                }
                
            } catch (e) {
                console.log('ÂÖ®ÈÅ∏ÊäûÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function updateSelectAllButton() {
            try {
                const grammarButtons = document.querySelectorAll('#grammarCategories .grammar-btn');
                const selectedButtons = document.querySelectorAll('#grammarCategories .grammar-btn.selected');
                const selectAllBtn = document.getElementById('selectAllGrammarBtn');
                const selectAllIcon = selectAllBtn.querySelector('.select-all-icon');
                const selectAllText = selectAllBtn.querySelector('.select-all-text');
                
                if (selectedButtons.length === grammarButtons.length && grammarButtons.length > 0) {
                    // ÂÖ®ÈÅ∏ÊäûÁä∂ÊÖã
                    isAllSelected = true;
                    selectAllBtn.classList.add('active');
                    selectAllIcon.textContent = '‚òë';
                    selectAllText.textContent = '„Åô„Åπ„Å¶Ëß£Èô§';
                } else {
                    // ÈÉ®ÂàÜÈÅ∏Êäû„Åæ„Åü„ÅØÊú™ÈÅ∏ÊäûÁä∂ÊÖã
                    isAllSelected = false;
                    selectAllBtn.classList.remove('active');
                    selectAllIcon.textContent = '‚òê';
                    selectAllText.textContent = '„Åô„Åπ„Å¶ÈÅ∏Êäû';
                }
                
            } catch (e) {
                console.log('ÂÖ®ÈÅ∏Êäû„Éú„Çø„É≥Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        /* ÁîªÈù¢ÈÅ∑ÁßªÈñ¢Êï∞ */
        function updateBackButton() {
            const backBtn = document.getElementById('footerBackBtn');
            const homeBtn = document.getElementById('footerHomeBtn');
            
            if (currentScreen === 'main') {
                backBtn.style.opacity = '0.5';
                backBtn.style.pointerEvents = 'none';
                homeBtn.style.opacity = '0.5';
                homeBtn.style.pointerEvents = 'none';
            } else {
                backBtn.style.opacity = '1';
                backBtn.style.pointerEvents = 'auto';
                homeBtn.style.opacity = '1';
                homeBtn.style.pointerEvents = 'auto';
            }
        }

        function hideAllModals() {
            try {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                });
            } catch (e) {
                console.log('„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function goBackToMain() {
            try {
                hideAllModals();
                const gameScreen = document.getElementById('gameScreen');
                if (gameScreen) {
                    gameScreen.classList.add('hidden');
                }
                const mainModal = document.getElementById('mainGradeModal');
                if (mainModal) {
                    mainModal.classList.add('show');
                }
                currentScreen = 'main';
                updateBackButton();
                soundSystem.playClick();
                currentGrade = '';
                
                resetLessonSelections();
                selectedLessons = [];
                selectedGrammarItems = [];
                
            } catch (e) {
                console.log('„É°„Ç§„É≥ÁîªÈù¢„Å∏„ÅÆÈÅ∑Áßª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function resetLessonSelections() {
            try {
                ['grade1', 'grade2', 'grade3'].forEach(grade => {
                    const container = document.getElementById(`${grade}Lessons`);
                    if (container) {
                        container.querySelectorAll('.lesson-btn').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                    }

                    const gradeNum = grade.replace('grade', '');
                    const startButton = document.getElementById(`startMultipleLessons${gradeNum}`);
                    if (startButton) {
                        startButton.style.display = 'none';
                        startButton.disabled = true;
                    }
                });
            } catch (e) {
                console.log('„É¨„ÉÉ„Çπ„É≥ÈÅ∏Êäû„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function goBackToGrade(grade) {
            try {
                hideAllModals();
                const gradeModal = document.getElementById(`${grade}Modal`);
                if (gradeModal) {
                    gradeModal.classList.add('show');
                }
                currentScreen = 'grade';
                updateBackButton();
                soundSystem.playClick();
                selectedGrammarItems = [];
            } catch (e) {
                console.log('Â≠¶Âπ¥ÁîªÈù¢„Å∏„ÅÆÈÅ∑Áßª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function goBackToGameSettings() {
            try {
                hideAllModals();
                const gameScreen = document.getElementById('gameScreen');
                if (gameScreen) {
                    gameScreen.classList.remove('hidden');
                }
                currentScreen = 'game';
                updateBackButton();
                soundSystem.playClick();
                
                resetQuizState();
                
            } catch (e) {
                console.log('„Ç≤„Éº„É†Ë®≠ÂÆöÁîªÈù¢„Å∏„ÅÆÈÅ∑Áßª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function resetQuizState() {
            try {
                usedQuestions = [];
                currentQuestionIndex = 0;
                sequentialIndex = 0;
                isQuizAnswered = false;
                
                stopTimer();
            } catch (e) {
                console.log('„ÇØ„Ç§„Ç∫Áä∂ÊÖã„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function goBack() {
            try {
                incrementClickCount();
                soundSystem.playClick();
                
                if (currentScreen === 'quiz') {
                    goBackToGameSettings();
                } else if (currentScreen === 'game') {
                    goBackToGrade(currentGrade);
                } else if (currentScreen === 'grammar') {
                    goBackToGrade(currentGrade);
                } else if (currentScreen === 'grade') {
                    goBackToMain();
                } else if (currentScreen === 'voice') {
                    closeVoiceSettings();
                } else {
                    goBackToMain();
                }
            } catch (e) {
                console.log('Êàª„ÇãÂãï‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* Èü≥Â£∞Ê©üËÉΩÈñ¢Êï∞ÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ */
        function generateSimpleVoiceSelection() {
            const container = document.getElementById('simpleVoiceSelection');
            if (!container) return;
            
            const deviceInfo = voiceSystem.getDeviceInfo();
            
            const simpleHTML = `
                <div class="simple-voice-container">
                    <div class="voice-selection-title">
                        üé§ Èü≥Â£∞ÈÅ∏Êäû
                    </div>
                    
                    <div class="voice-gender-btn" data-voice-gender="male" onclick="selectAndTestVoice('male')">
                        <div class="voice-gender-icon">üë®</div>
                        <div class="voice-gender-label">Áî∑ÊÄßÈü≥Â£∞</div>
                        <div class="voice-gender-description">
                            ${deviceInfo.typeName}„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁî∑ÊÄß„ÅÆÈü≥Â£∞
                        </div>
                    </div>

                    <div class="voice-gender-btn" data-voice-gender="female" onclick="selectAndTestVoice('female')">
                        <div class="voice-gender-icon">üë©</div>
                        <div class="voice-gender-label">Â•≥ÊÄßÈü≥Â£∞</div>
                        <div class="voice-gender-description">
                            ${deviceInfo.typeName}„Å´ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÂ•≥ÊÄß„ÅÆÈü≥Â£∞
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <div class="text-xs text-gray-600">
                            üí° ÁèæÂú®ÈÅ∏Êäû‰∏≠: ${deviceInfo.selectedVoice}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            üîä Èü≥Â£∞Ê©üËÉΩ: ${voiceSystem.isEnabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            üéØ ÂàùÊúüÂåñÁä∂ÊÖã: ${deviceInfo.isInitialized ? 'ÂÆå‰∫Ü' : 'ÈÄ≤Ë°å‰∏≠'}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = simpleHTML;
            
            if (voiceSystem.selectedVoice) {
                const currentGender = (voiceSystem.selectedVoice === voiceSystem.currentMaleVoice) ? 'male' : 'female';
                voiceSystem.updateVoiceSelectionUI(currentGender);
            }
        }

        function selectAndTestVoice(gender) {
            incrementClickCount();
            soundSystem.playClick();
            
            if (voiceSystem.selectGenderVoice(gender)) {
                console.log(`‚úÖ ${gender}Èü≥Â£∞„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
                setTimeout(() => {
                    voiceSystem.testVoice(gender);
                }, 300);
            }
        }

        function openVoiceSettings() {
            try {
                const modal = document.getElementById('voiceSettingsModal');
                const enabledCheckbox = document.getElementById('voiceEnabled');
                const toggleDescription = document.getElementById('voiceToggleDescription');
                
                if (enabledCheckbox && toggleDescription) {
                    enabledCheckbox.checked = voiceSystem.isEnabled;
                    toggleDescription.textContent = voiceSystem.isEnabled ? 'Èü≥Â£∞Ê©üËÉΩ„ÅåÊúâÂäπ„Åß„Åô' : 'Èü≥Â£∞Ê©üËÉΩ„ÅåÁÑ°Âäπ„Åß„Åô';
                }
                
                generateSimpleVoiceSelection();
                
                currentScreen = 'voice';
                updateBackButton();
                
                if (modal) {
                    modal.classList.add('show');
                }
                
                console.log('Èü≥Â£∞Ë®≠ÂÆöÁîªÈù¢Ë°®Á§∫ÔºàNEW CROWNÂÆåÂÖ®ÁâàÔºâ');
                
            } catch (e) {
                console.log('Èü≥Â£∞Ë®≠ÂÆöÁîªÈù¢„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function closeVoiceSettings() {
            try {
                const modal = document.getElementById('voiceSettingsModal');
                if (modal) {
                    modal.classList.remove('show');
                }
                
                if (currentScreen === 'voice') {
                    currentScreen = 'main';
                    hideAllModals();
                    const mainModal = document.getElementById('mainGradeModal');
                    if (mainModal) {
                        mainModal.classList.add('show');
                    }
                }
                
                updateBackButton();
            } catch (e) {
                console.log('Èü≥Â£∞Ë®≠ÂÆöÁîªÈù¢„ÅÆÈñâ„Åò„Çã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function toggleVoiceEnabled() {
            try {
                const checkbox = document.getElementById('voiceEnabled');
                const description = document.getElementById('voiceToggleDescription');
                
                if (checkbox && description) {
                    voiceSystem.setEnabled(checkbox.checked);
                    description.textContent = checkbox.checked ? 'Èü≥Â£∞Ê©üËÉΩ„ÅåÊúâÂäπ„Åß„Åô' : 'Èü≥Â£∞Ê©üËÉΩ„ÅåÁÑ°Âäπ„Åß„Åô';
                }
            } catch (e) {
                console.log('Èü≥Â£∞Âàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* „É¨„ÉÉ„Çπ„É≥ÈÅ∏ÊäûÊ©üËÉΩ */
        function toggleLessonSelection(grade, lessonId, lessonName) {
            try {
                const lessonBtn = document.querySelector(`#${grade}Lessons [data-lesson-id="${lessonId}"]`);
                
                if (!lessonBtn) {
                    console.error('„É¨„ÉÉ„Çπ„É≥„Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', lessonId);
                    return;
                }

                const isSelected = lessonBtn.classList.contains('selected');
                
                if (isSelected) {
                    lessonBtn.classList.remove('selected');
                    selectedLessons = selectedLessons.filter(lesson => lesson.id !== lessonId);
                } else {
                    lessonBtn.classList.add('selected');
                    selectedLessons.push({id: lessonId, name: lessonName, grade: grade});
                }
                
                updateSelectedLessonsDisplay(grade);
                
            } catch (e) {
                console.error('„É¨„ÉÉ„Çπ„É≥ÈÅ∏ÊäûÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        function updateSelectedLessonsDisplay(grade) {
            try {
                const gradeNum = grade.replace('grade', '');
                const startButton = document.getElementById(`startMultipleLessons${gradeNum}`);
                
                const gradeSelectedLessons = selectedLessons.filter(lesson => lesson.grade === grade);
                
                if (gradeSelectedLessons.length > 0) {
                    startButton.style.display = 'inline-block';
                    startButton.disabled = false;
                } else {
                    startButton.style.display = 'none';
                    startButton.disabled = true;
                }
                
            } catch (e) {
                console.log('ÈÅ∏Êäû„É¨„ÉÉ„Çπ„É≥Ë°®Á§∫Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function startSelectedLessons(grade) {
            try {
                if (selectedLessons.length === 0) {
                    return;
                }
                
                currentGrade = grade;
                showGrammarSelection();
                
            } catch (e) {
                console.log('„É¨„ÉÉ„Çπ„É≥ÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function showGrammarSelection() {
            try {
                hideAllModals();
                
                const modal = document.getElementById('grammarModal');
                const title = document.getElementById('grammarModalTitle');
                const container = document.getElementById('grammarCategories');
                
                title.textContent = `üìö ${selectedLessons.map(l => l.name).join(', ')} - Â≠¶ÁøíÂÜÖÂÆπÈÅ∏Êäû`;
                
                container.innerHTML = '';
                selectedGrammarItems = [];
                
                isAllSelected = false;
                updateSelectAllButton();
                
                selectedLessons.forEach(lesson => {
                    const lessonData = lessons[lesson.grade].find(l => l.id === lesson.id);
                    if (lessonData) {
                        lessonData.grammar.forEach(grammar => {
                            const btn = document.createElement('button');
                            btn.className = 'grammar-btn';
                            btn.textContent = grammar.name;
                            btn.dataset.grammarId = grammar.id;
                            btn.dataset.lessonId = lesson.id;
                            btn.dataset.grade = lesson.grade;
                            
                            btn.addEventListener('click', () => {
                                incrementClickCount();
                                soundSystem.playClick();
                                toggleGrammarSelection(btn, grammar, lesson);
                            });
                            
                            container.appendChild(btn);
                        });
                    }
                });
                
                currentScreen = 'grammar';
                updateBackButton();
                modal.classList.add('show');
                
            } catch (e) {
                console.log('ÊñáÊ≥ïÈÅ∏ÊäûÁîªÈù¢Ë°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function toggleGrammarSelection(btn, grammar, lesson) {
            try {
                const isSelected = btn.classList.contains('selected');
                const grammarKey = grammar.id;
                
                if (isSelected) {
                    btn.classList.remove('selected');
                    selectedGrammarItems = selectedGrammarItems.filter(item => item.key !== grammarKey);
                } else {
                    btn.classList.add('selected');
                    selectedGrammarItems.push({
                        key: grammarKey,
                        lessonId: lesson.id,
                        grammarId: grammar.id,
                        name: grammar.name,
                        grade: lesson.grade
                    });
                }
                
                updateSelectAllButton();
                
                const startButton = document.getElementById('startGrammarQuiz');
                if (selectedGrammarItems.length > 0) {
                    startButton.disabled = false;
                } else {
                    startButton.disabled = true;
                }
                
            } catch (e) {
                console.log('ÊñáÊ≥ïÈÅ∏ÊäûÂàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function startGrammarQuiz() {
            try {
                if (selectedGrammarItems.length === 0) {
                    return;
                }
                
                prepareQuestions();
                showGameScreen();
                
            } catch (e) {
                console.log('ÊñáÊ≥ï„ÇØ„Ç§„Ç∫ÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* problems.jsÈÄ£Êê∫„Å´„Çà„ÇãÂïèÈ°åÊ∫ñÂÇôÔºà‰øÆÊ≠£ÁâàÔºâ */
        function prepareQuestions() {
            try {
                allQuestions = [];
                
                if (typeof problemDatabase === 'undefined') {
                    console.error('‚ùå problems.js„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    alert('ÂïèÈ°å„Éá„Éº„Çø„Éï„Ç°„Ç§„É´Ôºàproblems.jsÔºâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n„Éï„Ç°„Ç§„É´„ÅåÊ≠£„Åó„ÅèÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                console.log('üìö problems.jsÈÄ£Êê∫ÈñãÂßã (NEW CROWNÂÆåÂÖ®Áâà)');
                console.log('Âà©Áî®ÂèØËÉΩ„Å™ÂïèÈ°å„Éá„Éº„Çø„Ç≠„Éº:', Object.keys(problemDatabase));
                
                selectedGrammarItems.forEach(item => {
                    const problemKey = `${item.grade}_${item.grammarId}`;
                    console.log(`üîç ÂïèÈ°åÊ§úÁ¥¢: ${problemKey}`);
                    
                    const problems = problemDatabase[problemKey];
                    if (problems && Array.isArray(problems)) {
                        console.log(`‚úÖ ÂïèÈ°åÁô∫Ë¶ã: ${problemKey} - ${problems.length}Âïè`);
                        problems.forEach(problem => {
                            allQuestions.push({
                                jp: problem.q,
                                en: problem.ans,
                                explanation: problem.exp || 'Ëß£Ë™¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                                grammarName: item.name,
                                lessonId: item.lessonId,
                                grade: item.grade,
                                problemKey: problemKey
                            });
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è ÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${problemKey}`);
                    }
                });
                
                if (allQuestions.length === 0) {
                    console.warn('‚ö†Ô∏è ÈÅ∏Êäû„Åï„Çå„ÅüÂÜÖÂÆπ„ÅÆÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    
                    allQuestions = [
                        {
                            jp: "ÁßÅ„ÅØÂä†Ëó§Èô∏„Åß„Åô„ÄÇ",
                            en: "I am Kato Riku.",
                            explanation: "Ëá™Â∑±Á¥π‰ªã„ÅÆÂü∫Êú¨Ë°®Áèæ„Åß„Åô„ÄÇ„ÄåI am + ÂêçÂâç„Äç„Åß„ÄåÁßÅ„ÅØ„Äú„Åß„Åô„Äç„Å®Ë®Ä„Åà„Åæ„Åô„ÄÇ",
                            grammarName: "Ëá™Â∑±Á¥π‰ªã",
                            lessonId: "sample",
                            grade: currentGrade
                        },
                        {
                            jp: "„Åì„Çå„ÅØËã±Ë™û„ÅÆÊú¨„Åß„Åô„ÄÇ",
                            en: "This is an English book.",
                            explanation: "„ÄåThis is + ÂêçË©û„Äç„Åß„Äå„Åì„Çå„ÅØ„Äú„Åß„Åô„Äç„ÇíË°®„Åó„Åæ„Åô„ÄÇÂÜ†Ë©û„ÅÆan„ÅØÊØçÈü≥„ÅßÂßã„Åæ„ÇãÂçòË™û„ÅÆÂâç„Å´‰Ωø„ÅÑ„Åæ„Åô„ÄÇ",
                            grammarName: "This/That",
                            lessonId: "sample",
                            grade: currentGrade
                        },
                        {
                            jp: "„ÅÇ„Å™„Åü„ÅØÈáéÁêÉ„Åå„Åß„Åç„Åæ„Åô„ÅãÔºü",
                            en: "Can you play baseball?",
                            explanation: "„ÄåCan you + ÂãïË©û„ÅÆÂéüÂΩ¢Ôºü„Äç„Åß„Äå„Äú„Åß„Åç„Åæ„Åô„ÅãÔºü„Äç„Å®„ÅÑ„ÅÜÁñëÂïèÊñá„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
                            grammarName: "CanÁñëÂïèÊñá",
                            lessonId: "sample",
                            grade: currentGrade
                        }
                    ];
                    
                    alert('üìù ÈÅ∏Êäû„Åï„Çå„ÅüÂÜÖÂÆπ„ÅÆÂïèÈ°å„Éá„Éº„Çø„Åå„Åæ„Å†Ê∫ñÂÇô„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n„Çµ„É≥„Éó„É´ÂïèÈ°å„ÅßÂ≠¶Áøí„ÇíÁ∂ö„Åë„Åæ„Åô„ÄÇ');
                }
                
                usedQuestions = [];
                currentQuestionIndex = 0;
                sequentialIndex = 0;
                
                console.log(`‚úÖ ÂïèÈ°åÊ∫ñÂÇôÂÆå‰∫Ü: ${allQuestions.length}Âïè`);
                console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÊñáÊ≥ïÈ†ÖÁõÆ:', selectedGrammarItems.map(item => item.name).join(', '));
                
            } catch (e) {
                console.error('‚ùå ÂïèÈ°åÊ∫ñÂÇô„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                alert('ÂïèÈ°å„ÅÆÊ∫ñÂÇô‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function showGameScreen() {
            try {
                hideAllModals();
                const gameScreen = document.getElementById('gameScreen');
                gameScreen.classList.remove('hidden');
                
                const categoryElement = document.getElementById('currentCategory');
                categoryElement.textContent = selectedGrammarItems.map(item => item.name).join(', ');
                
                updateClickDisplays();
                
                currentScreen = 'game';
                updateBackButton();
                
            } catch (e) {
                console.log('„Ç≤„Éº„É†ÁîªÈù¢Ë°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* „Çø„Ç§„Éû„ÉºÊ©üËÉΩ */
        function startTimer() {
            try {
                if (timerLimit === 'unlimited') {
                    updateTimerDisplayUnlimited();
                    return;
                }
                
                currentTimerValue = timerLimit;
                isTimerRunning = true;
                updateTimerDisplay();
                
                timerInterval = setInterval(() => {
                    currentTimerValue--;
                    updateTimerDisplay();
                    
                    if (currentTimerValue <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        handleTimerExpired();
                    } else if (currentTimerValue <= 2) {
                        soundSystem.playTick();
                    }
                }, 1000);
                
            } catch (e) {
                console.log('„Çø„Ç§„Éû„ÉºÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function updateTimerDisplay() {
            try {
                const timerValue = document.getElementById('timerValue');
                const timerDisplay = document.getElementById('timerDisplay');
                
                if (timerValue && timerDisplay) {
                    timerValue.textContent = currentTimerValue;
                    
                    if (currentTimerValue > 3) {
                        timerDisplay.className = 'timer-display timer-normal';
                    } else if (currentTimerValue > 1) {
                        timerDisplay.className = 'timer-display timer-warning';
                    } else {
                        timerDisplay.className = 'timer-display timer-danger';
                    }
                }
            } catch (e) {
                console.log('„Çø„Ç§„Éû„ÉºË°®Á§∫Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function updateTimerDisplayUnlimited() {
            try {
                const timerValue = document.getElementById('timerValue');
                const timerDisplay = document.getElementById('timerDisplay');
                
                if (timerValue && timerDisplay) {
                    timerValue.textContent = '‚àû';
                    timerDisplay.className = 'timer-display timer-unlimited';
                }
            } catch (e) {
                console.log('ÁÑ°Âà∂Èôê„Çø„Ç§„Éû„ÉºË°®Á§∫Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function handleTimerExpired() {
            try {
                soundSystem.playTimeUp();
                
                if (!isQuizAnswered) {
                    showAnswer();
                }
                
            } catch (e) {
                console.log('„Çø„Ç§„Éû„ÉºÊúüÈôêÂàá„ÇåÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function stopTimer() {
            try {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                isTimerRunning = false;
            } catch (e) {
                console.log('„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: „ÇØ„Ç§„Ç∫Ê©üËÉΩÔºàË®ÄË™ûÊñπÂêëÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ** */
        function startQuiz() {
            try {
                if (allQuestions.length === 0) {
                    return;
                }
                
                hideAllModals();
                const gameScreenElement = document.getElementById('gameScreen');
                gameScreenElement.classList.add('hidden');
                
                const modal = document.getElementById('quizModal');
                modal.classList.add('show');
                
                currentScreen = 'quiz';
                updateBackButton();
                
                resetQuizState();
                
                showNextQuestion();
                
            } catch (e) {
                console.log('„ÇØ„Ç§„Ç∫ÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function showNextQuestion() {
            try {
                if (usedQuestions.length >= allQuestions.length) {
                    endQuiz();
                    return;
                }
                
                let nextQuestion;
                
                if (questionMode === 'random') {
                    const availableQuestions = allQuestions.filter((_, index) => !usedQuestions.includes(index));
                    const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                    nextQuestion = availableQuestions[randomIndex];
                    currentQuestionIndex = allQuestions.indexOf(nextQuestion);
                } else {
                    if (sequentialIndex >= allQuestions.length) {
                        sequentialIndex = 0;
                    }
                    nextQuestion = allQuestions[sequentialIndex];
                    currentQuestionIndex = sequentialIndex;
                }
                
                displayQuestion(nextQuestion);
                isQuizAnswered = false;
                
                const remainingElement = document.getElementById('remainingCount');
                if (remainingElement) {
                    remainingElement.textContent = `ÊÆã„Çä: ${allQuestions.length - usedQuestions.length}Âïè`;
                }
                
                startTimer();
                
            } catch (e) {
                console.log('Ê¨°„ÅÆÂïèÈ°åË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: ÂïèÈ°åË°®Á§∫Èñ¢Êï∞„ÅÆÂÆåÂÖ®‰øÆÊ≠£Áâà** */
        async function displayQuestion(question) {
            try {
                const questionElement = document.getElementById('quizQuestion');
                const answerDisplay = document.getElementById('answerDisplay');
                const answerContent = document.getElementById('answerContent');
                const showAnswerBtn = document.getElementById('showAnswerBtn');
                const nextBtn = document.getElementById('quizNext');
                
                console.log('üéØ ÂïèÈ°åË°®Á§∫ÈñãÂßã');
                console.log('Ë®ÄË™ûÊñπÂêëË®≠ÂÆö:', questionDirection);
                console.log('ÂïèÈ°å„Éá„Éº„Çø:', {jp: question.jp, en: question.en});
                
                // **ÈáçË¶Å‰øÆÊ≠£: Ë®ÄË™ûÊñπÂêë„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö**
                let questionText = '';
                let currentQuestionType = '';
                
                if (questionDirection === 'jp_to_en') {
                    // üáØüáµ‚Üíüá∫üá∏: Êó•Êú¨Ë™ûÂïèÈ°å ‚Üí Ëã±Ë™ûËß£Á≠î
                    questionText = question.jp;
                    currentQuestionType = 'jp_to_en';
                    console.log('üáØüáµ‚Üíüá∫üá∏ „É¢„Éº„Éâ: Êó•Êú¨Ë™ûÂïèÈ°åË°®Á§∫');
                } else if (questionDirection === 'en_to_jp') {
                    // üá∫üá∏‚ÜíüáØüáµ: Ëã±Ë™ûÂïèÈ°å ‚Üí Êó•Êú¨Ë™ûËß£Á≠î
                    questionText = question.en;
                    currentQuestionType = 'en_to_jp';
                    console.log('üá∫üá∏‚ÜíüáØüáµ „É¢„Éº„Éâ: Ëã±Ë™ûÂïèÈ°åË°®Á§∫');
                } else {
                    // „Éü„ÉÉ„ÇØ„Çπ„É¢„Éº„Éâ
                    const isJpToEn = Math.random() < 0.5;
                    if (isJpToEn) {
                        questionText = question.jp;
                        currentQuestionType = 'jp_to_en';
                        console.log('üîÄ „Éü„ÉÉ„ÇØ„Çπ: Êó•Êú¨Ë™ûÂïèÈ°åÈÅ∏Êäû');
                    } else {
                        questionText = question.en;
                        currentQuestionType = 'en_to_jp';
                        console.log('üîÄ „Éü„ÉÉ„ÇØ„Çπ: Ëã±Ë™ûÂïèÈ°åÈÅ∏Êäû');
                    }
                }
                
                // ÂïèÈ°å„Çø„Ç§„Éó„Çí‰øùÂ≠ò
                questionElement.dataset.questionType = currentQuestionType;
                
                // ÂïèÈ°åË°®Á§∫„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
                questionElement.innerHTML = '';
                
                // **ÈáçË¶Å‰øÆÊ≠£: Ëã±Ë™ûÂïèÈ°å„ÅÆÂ†¥Âêà„ÅØ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥‰ªò„Åç„ÅßË°®Á§∫**
                if (currentQuestionType === 'en_to_jp' && questionText.match(/[a-zA-Z]/)) {
                    console.log('üîä Ëã±Ë™ûÂïèÈ°å„ÅÆ„Åü„ÇÅ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ËøΩÂä†');
                    const questionWrapper = addSpeakButton(questionText);
                    
                    if (questionWrapper && questionWrapper.nodeType === Node.ELEMENT_NODE) {
                        questionElement.appendChild(questionWrapper);
                    } else {
                        questionElement.textContent = questionText;
                    }
                    
                    // Ëá™ÂãïÈü≥Â£∞ÂÜçÁîü
                    setTimeout(async () => {
                        console.log('üîä Ëã±Ë™ûÂïèÈ°å„ÅÆËá™ÂãïÈü≥Â£∞ÂÜçÁîü');
                        await speakEnglishText(questionText);
                    }, 1000);
                } else {
                    // Êó•Êú¨Ë™ûÂïèÈ°å„ÅØÈÄöÂ∏∏Ë°®Á§∫
                    console.log('üìù Êó•Êú¨Ë™ûÂïèÈ°åË°®Á§∫');
                    questionElement.textContent = questionText;
                }
                
                // UIÂàùÊúüÂåñ
                answerDisplay.classList.remove('show');
                answerContent.innerHTML = '<div class="text-gray-500" style="text-align: center;">Ëß£Á≠î„ÇíÂ£∞„Å´Âá∫„Åó„Å¶„Åã„ÇâËß£Á≠î„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Å≠ÔºÅ</div>';
                
                showAnswerBtn.disabled = false;
                showAnswerBtn.textContent = 'üí° Ëß£Á≠î„ÇíË¶ã„Çã';
                nextBtn.disabled = true;
                
                console.log('‚úÖ ÂïèÈ°åË°®Á§∫ÂÆå‰∫Ü');
                
            } catch (e) {
                console.error('‚ùå ÂïèÈ°åË°®Á§∫„Ç®„É©„Éº:', e);
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: Ëß£Á≠îË°®Á§∫Èñ¢Êï∞„ÅÆÂÆåÂÖ®‰øÆÊ≠£Áâà** */
        async function showAnswer() {
            try {
                const question = allQuestions[currentQuestionIndex];
                const questionElement = document.getElementById('quizQuestion');
                const answerDisplay = document.getElementById('answerDisplay');
                const answerContent = document.getElementById('answerContent');
                const showAnswerBtn = document.getElementById('showAnswerBtn');
                const nextBtn = document.getElementById('quizNext');
                
                stopTimer();
                isQuizAnswered = true;
                
                const currentQuestionType = questionElement.dataset.questionType;
                console.log('üí° Ëß£Á≠îË°®Á§∫ÈñãÂßã:', currentQuestionType);
                
                // **ÈáçË¶Å‰øÆÊ≠£: Ëß£Á≠î„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ≠£„Åó„ÅèÊ±∫ÂÆö**
                let answerText = '';
                if (currentQuestionType === 'jp_to_en') {
                    // Êó•Êú¨Ë™û‚ÜíËã±Ë™ûÂïèÈ°å„ÅÆÂ†¥Âêà„ÄÅËã±Ë™û„ÅåËß£Á≠î
                    answerText = question.en;
                    console.log('üáØüáµ‚Üíüá∫üá∏ Ëß£Á≠î: Ëã±Ë™ûË°®Á§∫‰∫àÂÆö');
                } else {
                    // Ëã±Ë™û‚ÜíÊó•Êú¨Ë™ûÂïèÈ°å„ÅÆÂ†¥Âêà„ÄÅÊó•Êú¨Ë™û„ÅåËß£Á≠î
                    answerText = question.jp;
                    console.log('üá∫üá∏‚ÜíüáØüáµ Ëß£Á≠î: Êó•Êú¨Ë™ûË°®Á§∫‰∫àÂÆö');
                }
                
                // Ëß£Á≠î„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
                answerContent.innerHTML = '';
                
                // Ëß£Á≠î„ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†‰ΩúÊàê
                const answerTextDiv = document.createElement('div');
                answerTextDiv.className = 'answer-text';
                
                // **ÈáçË¶Å‰øÆÊ≠£: Ëã±Ë™ûËß£Á≠î„ÅÆÂ†¥Âêà„ÅØ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥‰ªò„Åç„ÅßË°®Á§∫**
                if (currentQuestionType === 'jp_to_en' && answerText.match(/[a-zA-Z]/)) {
                    console.log('üîä Ëã±Ë™ûËß£Á≠î„ÅÆ„Åü„ÇÅ„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ËøΩÂä†');
                    const answerWrapper = addSpeakButton(answerText);
                    
                    if (answerWrapper && answerWrapper.nodeType === Node.ELEMENT_NODE) {
                        answerTextDiv.appendChild(answerWrapper);
                    } else {
                        answerTextDiv.textContent = answerText;
                    }
                    
                    // Ëá™ÂãïÈü≥Â£∞ÂÜçÁîü
                    setTimeout(async () => {
                        console.log('üîä Ëã±Ë™ûËß£Á≠î„ÅÆËá™ÂãïÈü≥Â£∞ÂÜçÁîü');
                        await speakEnglishText(answerText);
                    }, 1000);
                } else {
                    // Êó•Êú¨Ë™ûËß£Á≠î„ÅØÈÄöÂ∏∏Ë°®Á§∫
                    console.log('üìù Êó•Êú¨Ë™ûËß£Á≠îË°®Á§∫');
                    answerTextDiv.textContent = answerText;
                }
                
                // Ëß£Ë™¨‰ΩúÊàê
                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'explanation-text';
                explanationDiv.textContent = question.explanation || 'Ëß£Ë™¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                
                // Ëß£Á≠î„Ç®„É™„Ç¢„Å´ËøΩÂä†
                answerContent.appendChild(answerTextDiv);
                answerContent.appendChild(explanationDiv);
                
                // Ë°®Á§∫Áä∂ÊÖãÂ§âÊõ¥
                answerDisplay.classList.add('show');
                
                showAnswerBtn.disabled = true;
                showAnswerBtn.textContent = '‚úÖ Ëß£Á≠îÊ∏à„Åø';
                nextBtn.disabled = false;
                
                // Áµ±Ë®àÊõ¥Êñ∞
                studyCount++;
                document.getElementById('studyCount').textContent = studyCount;
                
                soundSystem.playStudyComplete();
                createParticle('‚≠ê', '#f59e0b', window.innerWidth / 2, window.innerHeight / 3);

                console.log('‚úÖ Ëß£Á≠îË°®Á§∫ÂÆå‰∫Ü');

            } catch (e) {
                console.error('‚ùå Ëß£Á≠îË°®Á§∫„Ç®„É©„Éº:', e);
            }
        }

        function nextQuestion() {
            try {
                usedQuestions.push(currentQuestionIndex);
                
                if (questionMode === 'sequential') {
                    sequentialIndex++;
                }
                
                incrementClickCount();
                soundSystem.playClick();
                showNextQuestion();
                
            } catch (e) {
                console.log('Ê¨°„ÅÆÂïèÈ°å„Å∏„ÅÆÁßªÂãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function endQuiz() {
            try {
                hideAllModals();
                
                const gameScreen = document.getElementById('gameScreen');
                gameScreen.classList.remove('hidden');
                
                currentScreen = 'game';
                updateBackButton();
                
                resetQuizState();
                
            } catch (e) {
                console.log('„ÇØ„Ç§„Ç∫ÁµÇ‰∫ÜÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* Ë®≠ÂÆöÈñ¢Êï∞Ôºà‰øÆÊ≠£ÁâàÔºâ */
        function setTimerLimit(seconds) {
            try {
                timerLimit = seconds;
                
                document.querySelectorAll('.timer-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (seconds === 'unlimited') {
                    document.getElementById('timerUnlimitedBtn').classList.add('active');
                } else {
                    document.getElementById(`timer${seconds}Btn`).classList.add('active');
                }
                
            } catch (e) {
                console.log('„Çø„Ç§„Éû„ÉºË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function setQuestionMode(mode) {
            try {
                questionMode = mode;
                
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                document.getElementById(`${mode}ModeBtn`).classList.add('active');
                
            } catch (e) {
                console.log('ÂïèÈ°å„É¢„Éº„ÉâË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* **ÈáçË¶Å‰øÆÊ≠£: Ë®ÄË™ûÊñπÂêëË®≠ÂÆö„ÇíÂÆåÂÖ®‰øÆÊ≠£** */
        function setQuestionDirection(direction) {
            try {
                questionDirection = direction;
                
                console.log('üåè Ë®ÄË™ûÊñπÂêëÂ§âÊõ¥:', direction);
                
                // ÂÖ®„Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('.direction-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Ê≠£„Åó„ÅÑ„Éú„Çø„É≥„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
                if (direction === 'jp_to_en') {
                    document.getElementById('jpToEnBtn').classList.add('active');
                    console.log('‚úÖ üáØüáµ‚Üíüá∫üá∏ ÈÅ∏Êäû: Êó•Êú¨Ë™ûÂïèÈ°å ‚Üí Ëã±Ë™ûËß£Á≠î');
                } else if (direction === 'en_to_jp') {
                    document.getElementById('enToJpBtn').classList.add('active');
                    console.log('‚úÖ üá∫üá∏‚ÜíüáØüáµ ÈÅ∏Êäû: Ëã±Ë™ûÂïèÈ°å ‚Üí Êó•Êú¨Ë™ûËß£Á≠î');
                } else if (direction === 'mixed') {
                    document.getElementById('mixedBtn').classList.add('active');
                    console.log('‚úÖ üîÄ „Éü„ÉÉ„ÇØ„ÇπÈÅ∏Êäû: „É©„É≥„ÉÄ„É†Âàá„ÇäÊõø„Åà');
                }
                
            } catch (e) {
                console.log('Ë®ÄË™ûÊñπÂêëË®≠ÂÆö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
            }
        }

        /* „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ */
        function initEventListeners() {
            try {
                console.log('„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñÈñãÂßã...');
                
                // Â≠¶Âπ¥ÈÅ∏Êäû„Éú„Çø„É≥
                const gradeButtons = document.querySelectorAll('[data-grade]');
                console.log('Áô∫Ë¶ã„Åï„Çå„ÅüÂ≠¶Âπ¥„Éú„Çø„É≥Êï∞:', gradeButtons.length);
                
                gradeButtons.forEach((btn, index) => {
                    console.log(`Â≠¶Âπ¥„Éú„Çø„É≥ ${index + 1}: ${btn.dataset.grade}`);
                    
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('Â≠¶Âπ¥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ:', btn.dataset.grade);
                        
                        incrementClickCount();
                        soundSystem.playClick();
                        
                        const grade = e.currentTarget.dataset.grade;
                        
                        // Ê∫ñÂÇô‰∏≠Â≠¶Âπ¥„ÅÆÂá¶ÁêÜ
                        if (grade === 'grade2' || grade === 'grade3') {
                            const gradeNum = grade.replace('grade', '');
                            alert(`üöß ‰∏≠Â≠¶${gradeNum}Âπ¥Áîü„ÅÆÂÜÖÂÆπ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ\n‰ªäÂæå„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºÅ`);
                            return;
                        }
                        
                        currentGrade = grade;
                        
                        hideAllModals();
                        resetLessonSelections();
                        
                        const targetModal = document.getElementById(grade + 'Modal');
                        if (targetModal) {
                            targetModal.classList.add('show');
                            console.log('„É¢„Éº„ÉÄ„É´Ë°®Á§∫:', grade + 'Modal');
                        } else {
                            console.error('„É¢„Éº„ÉÄ„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', grade + 'Modal');
                        }
                        
                        currentScreen = 'grade';
                        updateBackButton();
                    });
                });

                // „É¨„ÉÉ„Çπ„É≥ÈñãÂßã„Éú„Çø„É≥
                ['1', '2', '3'].forEach(gradeNum => {
                    const startBtn = document.getElementById(`startMultipleLessons${gradeNum}`);
                    if (startBtn) {
                        startBtn.addEventListener('click', () => {
                            incrementClickCount();
                            soundSystem.playClick();
                            startSelectedLessons(`grade${gradeNum}`);
                        });
                    }
                });

                // ÊñáÊ≥ï„ÇØ„Ç§„Ç∫ÈñãÂßã„Éú„Çø„É≥
                const startGrammarBtn = document.getElementById('startGrammarQuiz');
                if (startGrammarBtn) {
                    startGrammarBtn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        startGrammarQuiz();
                    });
                }

                // ÂÖ®ÈÅ∏Êäû„Éú„Çø„É≥
                const selectAllBtn = document.getElementById('selectAllGrammarBtn');
                if (selectAllBtn) {
                    selectAllBtn.addEventListener('click', toggleSelectAllGrammar);
                }

                // „ÇØ„Ç§„Ç∫ÈñãÂßã„Éú„Çø„É≥
                const startQuizBtn = document.getElementById('startQuizButton');
                if (startQuizBtn) {
                    startQuizBtn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        startQuiz();
                    });
                }

                // Ëß£Á≠îË°®Á§∫„Éú„Çø„É≥
                const showAnswerBtn = document.getElementById('showAnswerBtn');
                if (showAnswerBtn) {
                    showAnswerBtn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        showAnswer();
                    });
                }

                // Ê¨°„ÅÆÂïèÈ°å„Éú„Çø„É≥
                const nextBtn = document.getElementById('quizNext');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        nextQuestion();
                    });
                }

                // „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                const footerHomeBtn = document.getElementById('footerHomeBtn');
                if (footerHomeBtn) {
                    footerHomeBtn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        goBackToMain();
                    });
                }

                const footerBackBtn = document.getElementById('footerBackBtn');
                if (footerBackBtn) {
                    footerBackBtn.addEventListener('click', () => {
                        goBack();
                    });
                }

                const footerVoiceBtn = document.getElementById('footerVoiceBtn');
                if (footerVoiceBtn) {
                    footerVoiceBtn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        openVoiceSettings();
                    });
                }

                // Áµ±Ë®à„ÇØ„É™„ÉÉ„ÇØ„Åß„É™„Çª„ÉÉ„ÉàÁ¢∫Ë™ç
                const footerTotalStat = document.getElementById('footerTotalStat');
                if (footerTotalStat) {
                    footerTotalStat.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        confirmResetTotal();
                    });
                }

                const footerTodayStat = document.getElementById('footerTodayStat');
                if (footerTodayStat) {
                    footerTodayStat.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        confirmResetToday();
                    });
                }

                // Èü≥Â£∞ON/OFFÂàá„ÇäÊõø„Åà
                const voiceEnabled = document.getElementById('voiceEnabled');
                if (voiceEnabled) {
                    voiceEnabled.addEventListener('change', toggleVoiceEnabled);
                }

                // „Çø„Ç§„Éû„ÉºË®≠ÂÆö„Éú„Çø„É≥
                document.querySelectorAll('.timer-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        const time = btn.dataset.time;
                        setTimerLimit(time === 'unlimited' ? 'unlimited' : parseInt(time));
                    });
                });

                // ÂïèÈ°å„É¢„Éº„ÉâË®≠ÂÆö„Éú„Çø„É≥
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        const mode = btn.dataset.mode;
                        setQuestionMode(mode);
                    });
                });

                // **ÈáçË¶Å‰øÆÊ≠£: Ë®ÄË™ûÊñπÂêëË®≠ÂÆö„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº**
                document.querySelectorAll('.direction-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        incrementClickCount();
                        soundSystem.playClick();
                        const direction = btn.dataset.direction;
                        console.log('Ë®ÄË™ûÊñπÂêë„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ:', direction);
                        setQuestionDirection(direction);
                    });
                });

                console.log('‚úÖ ÂÖ®„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');

            } catch (e) {
                console.error('‚ùå „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
        }

        /* „É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÔºàNEW CROWNÁâàÔºâ */
        function initLessonsAndGrammar() {
            try {
                console.log('„É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÈñãÂßã...');
                
                ['grade1', 'grade2', 'grade3'].forEach(grade => {
                    const container = document.getElementById(`${grade}Lessons`);
                    if (!container) {
                        console.error(`„Ç≥„É≥„ÉÜ„Éä„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${grade}Lessons`);
                        return;
                    }
                    
                    console.log(`${grade}„ÅÆ„É¨„ÉÉ„Çπ„É≥Êï∞: ${lessons[grade].length}`);
                    
                    lessons[grade].forEach(lesson => {
                        const btn = document.createElement('button');
                        btn.className = 'lesson-btn';
                        btn.innerHTML = lesson.name;
                        btn.setAttribute('data-lesson-id', lesson.id);
                        
                        btn.addEventListener('click', (e) => {
                            console.log('„É¨„ÉÉ„Çπ„É≥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ:', lesson.id, lesson.name);
                            incrementClickCount();
                            soundSystem.playClick();
                            toggleLessonSelection(grade, lesson.id, lesson.name);
                            e.preventDefault();
                        });
                        
                        container.appendChild(btn);
                        console.log(`${grade} - ${lesson.id}„ÅÆ„Éú„Çø„É≥„ÇíËøΩÂä†`);
                    });
                    
                    console.log(`${grade}„ÅÆ„É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÂÆå‰∫Ü`);
                });
                
                console.log('‚úÖ ÂÖ®„É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÂÆå‰∫Ü');
                
            } catch (e) {
                console.error('‚ùå „É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº:', e);
            }
        }

        /* „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== NEW CROWN Quiz ÂÆåÂÖ®‰øÆÊ≠£ÁâàÂàùÊúüÂåñÈñãÂßã ===');
            
            try {
                console.log('1. problems.jsÈÄ£Êê∫„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã');
                if (typeof problemDatabase !== 'undefined') {
                    console.log('‚úÖ problems.jsË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                    console.log(`üìä ÂïèÈ°å„Éá„Éº„ÇøÁµ±Ë®à: ${Object.keys(problemDatabase).length}È†ÖÁõÆ`);
                    
                    ['grade1', 'grade2', 'grade3'].forEach(grade => {
                        const gradeProblems = Object.keys(problemDatabase).filter(key => key.startsWith(grade));
                        console.log(`${grade}: ${gradeProblems.length}È†ÖÁõÆ`);
                    });
                } else {
                    console.warn('‚ö†Ô∏è problems.js„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÈÅÖÂª∂Ë™≠„ÅøËæº„Åø„ÇíË©¶Ë°å„Åó„Åæ„Åô„ÄÇ');
                    setTimeout(() => {
                        if (typeof problemDatabase !== 'undefined') {
                            console.log('‚úÖ problems.jsÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÊàêÂäü');
                        } else {
                            console.error('‚ùå problems.js„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        }
                    }, 1000);
                }
                
                console.log('2. „ÇØ„É™„ÉÉ„ÇØÁµ±Ë®àË™≠„ÅøËæº„ÅøÈñãÂßã');
                loadClickStats();
                console.log('‚úÖ „ÇØ„É™„ÉÉ„ÇØÁµ±Ë®àË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
                
                console.log('3. „É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÈñãÂßã');
                initLessonsAndGrammar();
                console.log('‚úÖ „É¨„ÉÉ„Çπ„É≥ÂàùÊúüÂåñÂÆå‰∫Ü');
                
                console.log('4. „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñÈñãÂßã');
                initEventListeners();
                console.log('‚úÖ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñÂÆå‰∫Ü');
                
                // Èö†„Åó„Å¶„Åä„Åè„Åπ„ÅçË¶ÅÁ¥†
                const gameScreen = document.getElementById('gameScreen');
                if (gameScreen) {
                    gameScreen.classList.add('hidden');
                }
                
                // ÂàùÊúüÁîªÈù¢Ë®≠ÂÆö
                currentScreen = 'main';
                updateBackButton();
                
                // **ÈáçË¶Å‰øÆÊ≠£: ÂàùÊúüÂÄ§Ë®≠ÂÆö„ÇíÊ≠£„Åó„ÅèÂÆüË°å**
                console.log('5. ÂàùÊúüË®≠ÂÆöÈñãÂßã');
                setTimerLimit(3);
                setQuestionMode('random');
                setQuestionDirection('jp_to_en');  // „Éá„Éï„Ç©„É´„Éà„ÅØÊó•Êú¨Ë™û‚ÜíËã±Ë™û
                console.log('‚úÖ ÂàùÊúüË®≠ÂÆöÂÆå‰∫Ü:', {
                    timer: timerLimit,
                    mode: questionMode,
                    direction: questionDirection
                });
                
                resetLessonSelections();
                
                // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
                document.addEventListener('voiceSystemReady', (event) => {
                    console.log('üé§ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü„Ç§„Éô„É≥„ÉàÂèó‰ø°:', event.detail);
                });
                
                // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆËøΩÂä†ÂàùÊúüÂåñ
                setTimeout(() => {
                    if (!voiceSystem.isInitialized) {
                        console.log('üîÑ Èü≥Â£∞ÂÜçÂàùÊúüÂåñÂÆüË°å');
                        voiceSystem.initializeVoices();
                    }
                }, 2000);
                
                // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂÜçË©¶Ë°å„ÉÅ„Çß„ÉÉ„ÇØ
                setTimeout(() => {
                    const deviceInfo = voiceSystem.getDeviceInfo();
                    console.log('üé§ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ:', deviceInfo);
                    if (!deviceInfo.isInitialized) {
                        console.warn('‚ö†Ô∏è Èü≥Â£∞ÂàùÊúüÂåñÊú™ÂÆå‰∫Ü„ÄÇÊâãÂãï„ÅßÂÜçÂàùÊúüÂåñ„Åó„Åæ„Åô„ÄÇ');
                        voiceSystem.initializeVoices();
                    }
                }, 5000);
                
                // ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ
                setTimeout(() => {
                    const finalDeviceInfo = voiceSystem.getDeviceInfo();
                    console.log('üéØ ÊúÄÁµÇÈü≥Â£∞„ÉÅ„Çß„ÉÉ„ÇØ:', finalDeviceInfo);
                    
                    if (finalDeviceInfo.totalVoices === 0) {
                        console.error('‚ùå Èü≥Â£∞„Åå‰∏Ä„Å§„ÇÇË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    } else {
                        console.log('‚úÖ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏Âãï‰ΩúÁ¢∫Ë™ç');
                    }
                }, 10000);
                
                console.log('=== NEW CROWN Quiz ÂÆåÂÖ®‰øÆÊ≠£ÁâàÂàùÊúüÂåñÂÆå‰∫Ü ===');
                console.log(`Â≠¶Âπ¥Âà•„É¨„ÉÉ„Çπ„É≥Êï∞: 1Âπ¥Áîü=${lessons.grade1.length}, 2Âπ¥Áîü„Éª3Âπ¥Áîü=Ê∫ñÂÇô‰∏≠`);
                console.log('„Éá„Éê„Ç§„ÇπË©≥Á¥∞ÊÉÖÂ†±:', voiceSystem.getDeviceInfo());
                console.log('problems.jsÈÄ£Êê∫:', typeof problemDatabase !== 'undefined' ? '‚úÖÊàêÂäü' : '‚ùåÂ§±Êïó');
                console.log('üéØ NEW CROWN Quiz ÂÆåÂÖ®‰øÆÊ≠£ÁâàÂÆåÊàê:');
                console.log('  ‚úÖ Ë®ÄË™ûÊñπÂêë„ÅÆÂïèÈ°å„ÇíÂÆåÂÖ®‰øÆÊ≠£Ê∏à„Åø');
                console.log('    - üáØüáµ‚Üíüá∫üá∏: Êó•Êú¨Ë™ûÂïèÈ°å‚ÜíËã±Ë™ûËß£Á≠î (Èü≥Â£∞‰ªò„Åç)');
                console.log('    - üá∫üá∏‚ÜíüáØüáµ: Ëã±Ë™ûÂïèÈ°å(Èü≥Â£∞‰ªò„Åç)‚ÜíÊó•Êú¨Ë™ûËß£Á≠î');
                console.log('    - üîÄ „Éü„ÉÉ„ÇØ„Çπ: „É©„É≥„ÉÄ„É†Âàá„ÇäÊõø„Åà(Èü≥Â£∞Ëá™ÂãïÂØæÂøú)');
                console.log('  ‚úÖ Ëã±Ë™ûÂïèÈ°å„ÉªËß£Á≠îÊôÇ„ÅÆËá™ÂãïÈü≥Â£∞ÂÜçÁîüÊ©üËÉΩÂÆåÂÖ®‰øÆÊ≠£');
                console.log('  ‚úÖ Ëã±Ë™û„ÉÜ„Ç≠„Çπ„Éà„Å´„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥ÂÆåÂÖ®‰øÆÊ≠£');
                console.log('  ‚úÖ Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Âº∑ÂåñÔºà„Éá„Éê„Ç§„ÇπÊúÄÈÅ©Âåñ„ÉªÂÜçË©¶Ë°åÊ©üËÉΩ„ÉªPromiseÂØæÂøúÔºâ');
                console.log('  ‚úÖ ‰∏≠Â≠¶1Âπ¥Áîü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„ÅøÂà©Áî®ÂèØËÉΩ');
                console.log('  ‚úÖ ‰∏≠Â≠¶2„Éª3Âπ¥Áîü„ÅØÊ∫ñÂÇô‰∏≠Ë°®Á§∫„Å®„Ç¢„É©„Éº„Éà');
                console.log('  ‚úÖ problems.jsÂÆåÂÖ®ÈÄ£Êê∫ÂØæÂøú');
                console.log('  ‚úÖ PC„Éª„Çπ„Éû„Éõ„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÂÆåÂÖ®ÂØæÂøú');
                
            } catch (error) {
                console.error('=== ÂàùÊúüÂåñ„Ç®„É©„Éº ===', error);
                alert('ÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        });

        /* „Éá„Éê„ÉÉ„Ç∞Áî®„Ç≥„É≥„ÇΩ„Éº„É´ÊÉÖÂ†± */
        console.log('NEW CROWN Quiz „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºàÂÆåÂÖ®‰øÆÊ≠£ÁâàÔºâ');
        console.log('Âà©Áî®ÂèØËÉΩ„Å™Â≠¶Âπ¥:', Object.keys(lessons));
        console.log('Â≠¶Âπ¥Âà•„É¨„ÉÉ„Çπ„É≥Êï∞:', {
            grade1: lessons.grade1.length,
            grade2: lessons.grade2.length,
            grade3: lessons.grade3.length
        });

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨ÈñãÔºà„Éá„Éê„ÉÉ„Ç∞„Éª„ÉÜ„Çπ„ÉàÁî®Ôºâ
        window.newCrownQuizDebug = {
            lessons,
            problemDatabase: () => typeof problemDatabase !== 'undefined' ? problemDatabase : null,
            clickStats,
            selectedLessons,
            selectedGrammarItems,
            allQuestions,
            incrementClickCount,
            currentScreen,
            voiceSystem,
            soundSystem,
            resetLessonSelections,
            resetQuizState,
            toggleSelectAllGrammar,
            updateSelectAllButton,
            questionDirection: () => questionDirection,
            testLanguageDirection: () => {
                console.log('=== Ë®ÄË™ûÊñπÂêë„ÉÜ„Çπ„ÉàÂÆåÂÖ®‰øÆÊ≠£Áâà ===');
                console.log('ÁèæÂú®„ÅÆË®≠ÂÆö:', questionDirection);
                console.log('‚úÖ jp_to_en: Êó•Êú¨Ë™ûÂïèÈ°å‚ÜíËã±Ë™ûËß£Á≠îÔºàÈü≥Â£∞„ÅÇ„ÇäÔºâ');
                console.log('‚úÖ en_to_jp: Ëã±Ë™ûÂïèÈ°åÔºàÈü≥Â£∞„ÅÇ„ÇäÔºâ‚ÜíÊó•Êú¨Ë™ûËß£Á≠î');
                console.log('‚úÖ mixed: „É©„É≥„ÉÄ„É†Âàá„ÇäÊõø„ÅàÔºàÈü≥Â£∞Ëá™ÂãïÂØæÂøúÔºâ');
                console.log('‚úÖ ‰øÆÊ≠£ÂÆå‰∫Ü: Ë®ÄË™ûÊñπÂêë„ÅåÊ≠£„Åó„ÅèÂãï‰Ωú„Åó„Åæ„Åô');
                
                // ÂÆüÈöõ„ÅÆË®≠ÂÆö„ÉÜ„Çπ„Éà
                console.log('--- Ë®≠ÂÆö„ÉÜ„Çπ„ÉàÂÆüË°å ---');
                setQuestionDirection('jp_to_en');
                console.log('jp_to_enË®≠ÂÆöÂæå:', questionDirection);
                setQuestionDirection('en_to_jp');
                console.log('en_to_jpË®≠ÂÆöÂæå:', questionDirection);
                setQuestionDirection('mixed');
                console.log('mixedË®≠ÂÆöÂæå:', questionDirection);
            },
            testVoice: async () => {
                console.log('Èü≥Â£∞„ÉÜ„Çπ„ÉàÈñãÂßã (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà)');
                try {
                    await voiceSystem.speak("This is a voice test for NEW CROWN Quiz. Hello World! Language direction and speaker buttons are now completely fixed.");
                    console.log('‚úÖ Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÆå‰∫Ü');
                } catch (error) {
                    console.error('‚ùå Èü≥Â£∞„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
                }
            },
            testSpeakerButton: () => {
                console.log('„Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥„ÉÜ„Çπ„ÉàÈñãÂßã');
                const testText = "Hello, this is a speaker button test.";
                const testElement = addSpeakButton(testText);
                console.log('‰ΩúÊàê„Åï„Çå„ÅüË¶ÅÁ¥†:', testElement);
                document.body.appendChild(testElement);
                setTimeout(() => {
                    document.body.removeChild(testElement);
                }, 5000);
            },
            getDeviceInfo: () => voiceSystem.getDeviceInfo(),
            resetClickStats: () => {
                clickStats = { total: 0, daily: {} };
                saveClickStats();
                updateClickDisplays();
            },
            checkLessonButtons: () => {
                console.log('=== „É¨„ÉÉ„Çπ„É≥„Éú„Çø„É≥„ÉÅ„Çß„ÉÉ„ÇØ (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà) ===');
                ['grade1', 'grade2', 'grade3'].forEach(grade => {
                    const container = document.getElementById(`${grade}Lessons`);
                    const buttons = container ? container.querySelectorAll('.lesson-btn') : [];
                    console.log(`${grade}: ${buttons.length}ÂÄã„ÅÆ„Éú„Çø„É≥`);
                    buttons.forEach((btn, index) => {
                        console.log(`  ${index + 1}. ID: ${btn.dataset.lessonId}, „ÉÜ„Ç≠„Çπ„Éà: ${btn.textContent.substring(0, 50)}...`);
                    });
                });
            },
            checkProblemsJs: () => {
                console.log('=== problems.jsË©≥Á¥∞„ÉÅ„Çß„ÉÉ„ÇØ (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà) ===');
                if (typeof problemDatabase !== 'undefined') {
                    console.log(`‚úÖ problems.jsË™≠„ÅøËæº„ÅøÊ∏à„Åø: ${Object.keys(problemDatabase).length}È†ÖÁõÆ`);
                    
                    ['grade1', 'grade2', 'grade3'].forEach(grade => {
                        const gradeKeys = Object.keys(problemDatabase).filter(key => key.startsWith(grade));
                        console.log(`${grade}: ${gradeKeys.length}È†ÖÁõÆ`);
                        gradeKeys.forEach(key => {
                            const problems = problemDatabase[key];
                            console.log(`  ${key}: ${problems ? problems.length : 0}Âïè`);
                        });
                    });
                } else {
                    console.error('‚ùå problems.js„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            },
            testLessonSelection: (lessonId) => {
                console.log('„É¨„ÉÉ„Çπ„É≥ÈÅ∏Êäû„ÉÜ„Çπ„Éà (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà):', 'grade1', lessonId);
                const lesson = lessons.grade1.find(l => l.id === lessonId);
                if (lesson) {
                    toggleLessonSelection('grade1', lessonId, lesson.name);
                } else {
                    console.error('„É¨„ÉÉ„Çπ„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            },
            testSpecificVoice: (gender) => {
                console.log(`${gender}Èü≥Â£∞„ÉÜ„Çπ„ÉàÈñãÂßã (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà)`);
                voiceSystem.testVoice(gender);
            },
            forceVoiceReload: () => {
                console.log('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†Âº∑Âà∂ÂÜçË™≠„ÅøËæº„Åø (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà)');
                voiceSystem.initializeVoices();
            },
            testSelectAll: () => {
                console.log('ÂÖ®ÈÅ∏ÊäûÊ©üËÉΩ„ÉÜ„Çπ„Éà (NEW CROWNÂÆåÂÖ®‰øÆÊ≠£Áâà)');
                toggleSelectAllGrammar();
            },
            fullSystemTest: async () => {
                console.log('=== NEW CROWN Quiz ÂÆåÂÖ®„Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„Éà ===');
                console.log('1. Ë®ÄË™ûÊñπÂêë„ÉÜ„Çπ„Éà');
                window.newCrownQuizDebug.testLanguageDirection();
                console.log('2. Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„Éà');
                await window.newCrownQuizDebug.testVoice();
                console.log('3. „Çπ„Éî„Éº„Ç´„Éº„Éú„Çø„É≥„ÉÜ„Çπ„Éà');
                window.newCrownQuizDebug.testSpeakerButton();
                console.log('4. „Éá„Éê„Ç§„ÇπÊÉÖÂ†±');
                console.log(window.newCrownQuizDebug.getDeviceInfo());
                console.log('5. problems.jsÁ¢∫Ë™ç');
                window.newCrownQuizDebug.checkProblemsJs();
                console.log('‚úÖ ÂÆåÂÖ®„Ç∑„Çπ„ÉÜ„É†„ÉÜ„Çπ„ÉàÂÆå‰∫Ü');
            }
        };

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.confirmResetTotal = confirmResetTotal;
        window.confirmResetToday = confirmResetToday;
        window.selectAndTestVoice = selectAndTestVoice;
        window.closeVoiceSettings = closeVoiceSettings;
        window.toggleSelectAllGrammar = toggleSelectAllGrammar;

    </script>
</body>
</html>